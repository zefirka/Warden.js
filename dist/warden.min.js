!function(a,b){if("object"==typeof exports&&exports)module.exports=b();else{var c=b();"function"==typeof define&&define.amd?define(c):a.Warden=c}}(this,function(){"use strict";function each(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}function forWhile(a,b,c,d){c=c||!1;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return void 0!==d?d:!0}function filter(a,b){var c=[];return each(a,function(a,d){b(a,d)===!0&&c.push(a)}),c}function reduce(a,b){for(var c=a[0],d=1,e=a.length;e>d;d++)c=b(c,a[d]);return c}function map(a,b){var c=[];return each(a,function(a,d){c[d]=b(a,d)}),c}function some(a,b){return forWhile(a,b,!0,!1)}function every(a,b){return forWhile(a,b)}function truthy(a){return a?!0:!1}function typeIs(a){return function(b){return typeof b===a}}function trim(a){return a.replace(/^\s+|\s+$/g,"")}function not(a){return function(b){return!a(b)}}function toArray(a){return is.obj(a)&&!is.exist(a.length)&&(a.length=Object.keys(a).length),Array.prototype.slice.call(a)}function extend(){function a(a,b){if(!b||typeof b!==_OBJ)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}return reduce(toArray(arguments),function(b,c){return a(b,c)})}function Pipeline(a,b){function c(a,b){return b?f=0:f==d.length?(f=0,h.fin(a)):(f++,void d[f-1].apply(h.ctx,[a,g]))}var d=a||[],e=0,f=0,g={next:function(a){return c(a)},stop:function(){return f=0},pause:function(){return e=1},play:function(){return e=0},host:function(){return b}},h={pipe:function(a){return a?(d.push(a),h):d},start:function(a,b,g){return h.ctx=b,h.fin=g,f=e?0:f,f==d.length?(f=0,g(a)):void c(a)}};return h}var Warden=function(a,b){return Warden.extend(is.exist(a)?a:{},b)},jQueryInited="undefined"!=typeof jQuery;Warden.version="0.4.0",Warden.configure={history:3,cmp:function(a,b){return a===b}};var Utils,_FUN="function",_NUM="number",_STR="string",_OBJ="object",_ARR="array",_BOOL="boolean",_UND="undefined",is={exist:function(a){return typeof a!=_UND&&null!==a},array:function(a){return Array.isArray(a)},fn:typeIs(_FUN),num:typeIs(_NUM),str:typeIs(_STR),bool:typeIs(_BOOL),equals:function(a){return function(b){return a===b}}};is.obj=function(a){return typeIs(_OBJ)(a)&&!is.array(a)};var hashc=function(){var a={};return{get:function(b){return a[b]},set:function(b){return a[b]=((parseInt(a[b],16)||0)+1).toString(16)},clean:function(b){delete a[b]}}}();Utils={is:is,not:not,forWhile:forWhile,each:each,filter:filter,some:some,every:every,map:map,reduce:reduce,toArray:toArray,interpolate:function(a){var b={},c=arguments.length,d=Utils.toArray(arguments),e=/{{\s*[\w\.\/\[\]]+\s*}}/g;return 2==c&&is.obj(d[1])?b=d[1]:each(d.slice(1,c),function(a,c){b[c]=a}),a.replace(e,function(a){var c=Utils.getObject(b,a.slice(2,-2)),d=is.exist(c)?c:a;return is.obj(d)&&(d=JSON.stringify(d)),d})},extend:extend,trim:trim,getObject:function(a,b){return is.obj(a)?(each(b.split("/"),function(b){if(!is.exist(a))return a;var c;if("["==b[0]&&"]"==b[b.length-1]){if(c=b.slice(1,-1),is.exist(c)){if(!is.num(parseInt(c)))throw"Wrong syntax";b=parseInt(c)}}else is.exist(a[b])||(a={});a=a[b]}),a):a},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:hashc},Warden.Utils=Utils,Warden.extend=function(){function a(a){return/.?[\*\[\]\{\}\.\?\$\^\\\|].?/g.test(a)}function b(a){each(a,function(a,b){this[b]=a}.bind(this))}function c(a,b,c){Object.defineProperty(a,b,{configurable:!1,enumerable:!1,writable:!1,value:c})}var d="addEventListener",e="attachEvent",f={arrays:["pop","push","splice","reverse","shift","unshift","sort"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null},g={},h=function(a){g[a]=g[a]||[],each(toArray(arguments).slice(1),function(b){g[a].push(b)})},i=function(a){return g[a]||[]};return function(g,j){function k(a,b,c){return function(d){var e=this;if(every(b,function(a){return is.str(d)?a.type==d:a.type.test(d)})&&e[m.listener]){if(!is.str(d))throw new Error("Invalid format in: "+m.listener);this[m.listener].apply(this,[d,function(b){a.call(e,b)}])}h(e.$$id,{type:d,callback:c})}}function l(a,b,c){a[b]=c}var m=extend({},f,j||{}),n=is.exist(g)?g:{},o=!0,p=m.names;if(is.fn(g))n=g.prototype;else{if(typeof g!==_OBJ){var q=Warden.Stream().watch();return q.fire(g),q}o=!1,is.array(g)&&(b.prototype=Object.create(n),c(b.prototype,"repeatedly",function(){var a=this,b=a.length;return Warden.Stream(function(c){var d=0;setTimeout(function(){for(;b>d;)c(a[d++])})})}),c(b.prototype,"sequentially",function(a){var b=this,c=b.length;return Warden.Stream(function(d){var e=0,f=setInterval(function(){c>e?(d(b[e]),e++):(e=0,clearInterval(f))},a)})}),each(m.arrays,function(a){c(b.prototype,a,function(){var b=this;Array.prototype[a].apply(this,arguments),this.emit({type:a,prev:b,current:this,data:toArray(arguments)})})}),g=new b(g),n=b.prototype,l=function(a,b,d){return c(a,b,d)})}var r=n[p.emit]||n[p.listen]||n[p.unlisten]||n[p.stream];if(is.exist(r))throw new Error("Can't overwrite: "+(r.name?r.name:r)+" of object");return jQueryInited&&(o?!0:g instanceof jQuery)?(m.emitter=m.emitter||"trigger",m.listener=m.listener||"on"):(is.fn(n[d])||is.fn(n[e]))&&(m.listener=m.listener||(is.fn(n[d])?d:e)),l(n,p.emit,function(a,b){var c=this,d=is.str(a)?a:a.type,b=is.obj(a)?a:b||a,e=filter(i(this.$$id=this.$$id||hashc.set("o")),function(a){return is.str(a.type)?a.type==d:a.type.test(d)});return each(e,function(a){a.callback.call(c,b)}),this}),l(n,p.listen,function(b,c){var d=this,e=k(function(a){this.emit(a)},i(this.$$id=this.$$id||hashc.set("o")),c);return each(b.split(","),function(b){b=trim(b),e.call(d,a(b)?new RegExp(b):b)}),this}),l(n,p.unlisten,function(a,b){var c=[],a=trim(a),d=i(this.$$id=this.$$id||hashc.set("o"));return d.length&&(b?each(d,function(d,e){d.callback.name==(b.name||b)&&d.type.toString()==a.toString()&&c.push(e)}):c=new Array(d.length),each(c,function(a){d.splice(a,1)})),this}),l(n,p.stream,function(b,c){var d=this,e=Warden.Stream(null,c||this),f=function(a){e.fire(a,c||this)},g=k(f,i(this.$$id=this.$$id||hashc.set("o")),f);return each(b.split(","),function(b){b=trim(b),g.call(d,a(b)?new RegExp(b):b)}),e}),g}}(),Warden.Pipeline=Pipeline;var Stream=function(){function inheritFrom(a,b){return a.parent=b,b.children.push(a),a}function process(a){var b=pipes[this.$$id],c=b.pipe().slice();return c.push(a),inheritFrom(new Stream(c),this)}function Stream(a,b){var c=Warden.configure.history;this.$$id=Utils.$hash.set("d"),this.$$context=b||{},this.$$obs=!1,this.parent=null,this.children=[],handlers[this.$$id]=[],pipes[this.$$id]=Pipeline(a||[],this),this.data={fires:new Utils.Queue(c),takes:new Utils.Queue(c),last:null}}var handlers={},pipes={};return Stream.prototype={valueOf:function(a){return this.data.last},toString:function(a){return this.data.last.toString()},bindTo:function(){var a=Warden.Watcher.apply(null,[this].concat(toArray(arguments)));return a},exec:function(a,b){if(this.$$obs){var c=this.$$id,d=this;this.data.fires.push(a),pipes[c].start(a,b,function(a){d.data.takes.push(a),d.data.last=a,each(handlers[c],function(c){c.call(b,a)})})}},fire:function(a,b){if(!this.locked){if(b=b||this.$$context,!this.$$obs)return void each(this.children,function(c){c.fire(a,b)});this.exec(a,b),each(this.children,function(c){c.fire(a,b)})}},listen:function(a){return this.$$obs=!0,handlers[this.$$id].push(a),this},watch:function(){return this.$$obs=!0,this},mute:function(a){var b=this;return Utils.forWhile(handlers[this.$$id],function(c,d){return(is.fn(a)?c==a:c.name==a)?(handlers[b.$$id].splice(d,1),!1):void 0},!1),this},clear:function(){handlers[this.$$id]=[]},log:function(a){return this.listen(function(b){console.log(a?a.replace(/\$/g,b):b)})},filter:function(a){return is.fn(a)?process.call(this,function(b,c){return a.call(this,b)===!0?c.next(b):c.stop()}):process.call(this,function(b,c){return Warden.configure.cmp(a,b)===!0?c.next(b):c.stop()})},map:function(x){function parseEval(string){var res="";return res+=string.indexOf("@")>=0?"@"==string?"this":string.replace("@","this."):string.indexOf(".")>=0?"."==string?"event":string.replace(".","event."):"'"+string+"'",string.indexOf("$")>=0&&(res=string.replace(/\$/g,"event")),res.match(/\(.+\)/)&&(res=res.replace(/\(.+\)/,function(args){return"("+eval(args.slice(1,-1))+")"})),res}function map(i,event){return is.fn(i)?i.call(this,event):is.str(i)?eval(parseEval(i)):i}var fn=function(a,b){return b.next(x)};return fn="object"==typeof x?is.array(x)?function(a,b){var c=[],d=this;return each(x,function(b){c.push(map.call(d,b,a))}),b.next(c)}:function(a,b){var c={};for(var d in x)c[d]=map.call(this,x[d],a);return b.next(c)}:function(a,b){return b.next(map.call(this,x,a))},process.call(this,fn)},mapf:function(a){var b=function(b,c){return c.next(a.call(this,b))};return process.call(this,b)},reduce:function(a,b){var c=new Utils.Queue(1);return process.call(this,function(d,e){{var f;e.host()}return f=0==c.length?b?b.call(this,a,d):d:(b||a).call(this,c[c.length-1],d),c.push(f),e.next(f)})},take:function(a){return process.call(this,function(b,c){var d=c.host();return d.data.limit=d.data.limit||a,d.data.taken=d.data.taken+1||0,d.data.taken>=d.data.limit?c.stop():c.next(b)})},skip:function(a){var b=this;return process.call(this,function(c,d){b.skips=b.skips||0,b.skips==a?(delete b.skips,d.next(c)):(b.skips+=1,d.stop())})},interpolate:function(a){return process.call(this,function(b,c){return c.next(Utils.interpolate(a,b))})},mask:function(a){return process.call(this,function(b,c){return c.next(is.str(b)?Utils.interpolate(b,a):b)})},diff:function(a){return a=a||Warden.configure.cmp,process.call(this,function(b,c){var d=c.host().data,e=d.fires,f=d.takes,g=(e.length>1||f.length>0)&&(a(b,e[e.length-2])||a(b,f.last()));return g?c.stop():c.next(b)})},debounce:function(a){return process.call(this,function(b,c){var d=c.host();clearTimeout(d.data.dbtimer),d.data.dbtimer=setTimeout(function(){delete d.data.dbtimer,c.play(),c.next(b)},a),c.pause()})},collect:function(a){return process.call(this,function(b,c){{var d=c.host();d.data.fires.length-1}d.data.tmpCollection=d.data.tmpCollection||[],d.data.tmpCollection.push(b),d.data.timer?c.pause():(d.data.timer=setTimeout(function(){var a=d.data.tmpCollection;clearTimeout(d.data.timer),delete d.data.timer,delete d.data.tmpCollection,c.play(),c.next(a)},a),c.pause())})},filterFor:function(a){var b;return process.call(this,function(c,d){var e={get:function(a){return a?a(b):b},next:function(a,c){b=c?c(b,a):a,d.next(a)},stop:function(a){d.stop()}};return a(c,e)})},collectFor:function(a){var b=[];return this.listen(function(a){b.push(a)}),Warden.Stream(function(c){a.listen(function(){c(b),b=[]})})},delay:function(a){return process.call(this,function(b,c){setTimeout(function(){c.next(b)},a)})},toggle:function(a,b){var c=!1;return this.listen(function(d){c?b.call(this,d):a.call(this,d),c=!c})},after:function(a,b){var c=!1;return a.listen(function(){c=!0}),process.call(this,function(a,d){c?(c=b===!0?!1:!0,d.play(),d.next(a)):d.pause()})},repeat:function(a,b){var c=this,d=a;return inheritFrom(Warden.Stream(function(e){c.listen(function(c){var f=setInterval(function(){a?(e(c),a--):(a=d,clearInterval(f))},b)})}),this)},waitFor:function(a){var b=this;return Warden.Stream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(a){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).host()},merge:function(){var a=Warden.Stream(this.$$id,this.$$context),b=toArray(arguments);return b.push(this),each(b,function(b){b.listen(function(b){a.fire(b)})}),a},alternately:function(a){var b=this,c=0;return Warden.Stream(function(d){b.listen(function(a){0==c&&(d(a),c=1)}),a.listen(function(a){1==c&&(d(a),c=0)})})},resolve:function(a,b,c){var d=this;return Warden.Stream(function(e){d.sync(a).listen(function(a){e(b.call(c,a[0],a[1]))})},c||this.$$context)},combine:function(a,b,c){var d=this;return Warden.Stream(function(e){function f(a,c){e(b.call(d.$$context,a,c))}d.listen(function(b){f(b,a.data.last||c)}),a.listen(function(a){f(d.data.last||c,a)})},this.$$context)},sync:function(){var a,b=toArray(arguments),c=[],d=[];return b.unshift(this),c.length=d.length=b.length,a=Warden.Stream(function(a){each(b,function(e,f){e.listen(function(e){var g=d.length?!0:!1;Utils.forWhile(d,function(a,b){return b==f?!0:(a||(g=!1),a)},!1),c[f]=e,g?(a(c),c=[],d=[],c.length=d.length=b.length):d[f]=!0})})})},stream:function(){return inheritFrom(new Stream,this)},swap:function(a){function b(a,b){a.locked=!b,each(a.children,function(a){a.swap(b)})}b(this,a)},toggleOn:function(a,b){var c=this;a instanceof Stream&&a.listen(function(){c.swap(b)})},lock:function(a){return this.swap(!1),a&&this.toggleOn(a,!1),this},lockThis:function(){return this.locked=!0,this},unlockThis:function(){return this.locked=!1,this},unlock:function(a){return this.swap(!0),a&&this.toggleOn(a,!0),this}},Object.defineProperty(Stream.prototype,"value",{configurable:!0,get:function(){return this.data.last},set:function(a){this.fire(a)}}),Warden.configure.addToStream=function(a,b,c){Stream.prototype[a]=function(){arguments;return c?b.apply(this,arguments):process.call(this,b.apply(this,arguments))}},Warden.configure.isStream=function(a){return a instanceof Stream},Stream}();return Warden.Stream=function(a,b,c){var d,e,f,g=[];if(b=b||{},d=new Stream([],b),is.fn(a)){if(c===!0){e=a.toString();for(f in b)b.hasOwnProperty(f)&&g.push(f);g.length&&each(g,function(a){e.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",b)})}a.call(b,function(a,b){d.fire(a,b)})}return d},Warden.makeStream=Warden.Stream,Warden.Watcher=function(){var argv=Utils.toArray(arguments).slice(1,arguments.length),argc=argv.length,bus=arguments[0],a=argv[0],b=argv[1],fn,st;if(1===argc)is.str(a)?fn=function(b){this[a]=b}:is.fn(a)&&(fn=function(b){a(b)});else if(is.obj(a)&&is.str(b))if(b.indexOf("/")>=0){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function binding(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:fn=function(c){a[b]=c};else is.fn(b)&&(fn=function(c){b.call(a,c)});return st=fn,bus.listen(fn),{update:fn,remove:function(){bus.mute("binding")}}},Warden.Formula=function(a,b,c){var d=Warden.Stream(b.toString(),c||{});return each(a,function(e){e.listen(function(e){var f=b.apply(c||this,a);d.fire(f)})}),d.watch(),d.value=b.apply(c,a),d},jQueryInited&&Warden(jQuery),Warden});
//# sourceMappingURL=warden.min.js.map