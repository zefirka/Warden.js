!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(Warden){"use strict";function Processor(a,b){var c=a||[],d=0,e=0,f={$continue:function(a){return g.tick(a)},$break:function(){return g.tick({},1)},$lock:function(){return d=1},$unlock:function(){return d=0},$update:function(){b.update()},$host:function(){return b}},g={process:function(a){return a?c.push(a):c},start:function(a,b,f){return g.ctx=b,g.fin=f,e=d?0:e,e==c.length?(e=0,f(a)):void this.tick(a)},tick:function(a,b){return b?e=0:e==c.length?(e=0,g.fin(a)):(e++,void c[e-1].apply(g.ctx,[a,f]))}};return g}var jQueryInited="undefined"!=typeof jQuery;Warden.version="0.1.4",Warden.configure={cmp:function(a,b){return a===b}};var Utils,Analyze,UserMap={};!function(){function a(a){return function(b,c){var d=a[b],e=Utils.is.exist(d)?Utils.some(d,function(a){return typeof c===a}):!0;if(!e)throw"TypeError: unexpected type of argument at: ."+b+"(). Expected type: "+d.join(" or ")+". Your argument is type of: "+typeof c}}var b="function",c="number",d="string",e="object",f="array",g="boolean",h="undefined";Utils=function(){function a(a,b){return Array.prototype[a]?function(b,c){return Array.prototype[a].call(b,c)}:b}var f=a("forEach",function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}),h=function(a,b,c,d){c=c||!1;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return void 0!==d?d:!0},i=a("filter",function(a,b){var c=[];return f(a,function(a,d){b(a,d)===!0&&c.push(a)}),c}),j=a("reduce",function(a,b){for(var c=a[0],d=1,e=a.length;e>d;d++)c=b(c,a[d]);return c}),k=a("map",function(a,b){var c=[];return f(a,function(a,d){c[d]=b(a,d)}),c}),l=a("some",function(a,b){return h(a,b,!0,!1)}),m=a("every",function(a,b){return h(a,b)}),n=function(a){return a?!0:!1},o=function(a){return function(b){return typeof b===a}},p=function(a){return function(b){return!a(b)}},q={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:o(b),num:o(c),str:o(d),bool:o(g),truthy:n,falsee:p(n),equals:function(a){return function(b){return a===b}}};return q.obj=function(a){return o(e)(a)&&!q.array(a)},q.not=function(){var a={};for(var b in q)a[b]=p(q[b]);return a}(),{is:q,not:p,forEach:f,forWhile:h,each:f,filter:i,some:l,every:m,map:k,reduce:j,toArray:function(a){return q.obj(a)&&q.not.exist(a.length)&&(a.length=Object.keys(a).length),Array.prototype.slice.call(a)},interpolate:function(a){var b={},c=arguments.length,d=Utils.toArray(arguments),e=/{{\s*[\w\.]+\s*}}/g;return 2==c&&q.obj(d[1])?b=d[1]:f(d.slice(1,c),function(a,c){b[c]=a}),a.replace(e,function(a){var c=b[a.slice(2,-2)]||a;return q.obj(c)&&(c=JSON.stringify(c)),c})},log:function(){console.log(interpolate.apply(this,arguments))},flatten:function(a){var b=[];return f(a,function(a){q.array(a)?b=b.concat(Utils.flatten(a)):b.push(a)}),b},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},extend:function(){function a(a,b){if(!b||"object"!=typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}return Utils.toArray(arguments).reduce(function(b,c){return a(b,c)})},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:function(){var a={};return{get:function(b){return a[b]},set:function(b){return a[b]=((parseInt(a[b],16)||0)+1).toString(16)}}}()}}(),Analyze=a({extend:[e,b,f],listen:[d],stream:[d],unlisten:[d],reduce:[b],include:[d],take:[c],filter:[b],skip:[c],setup:[b],makeStream:[h,d,b,f],debounce:[c],getCollected:[c],interpolate:[d],mask:[e],unique:[b,h],lock:[d],nth:[c],get:[d]}),Warden.configure.exceptionMap={},Warden.configure.exceptionManager=a(Warden.configure.exceptionMap)}(),Warden.Utils=Utils,Warden.configure.datatypes=function(a,b){if(Analyze.MAP[a])throw"This name is already exist";Analyze.MAP[a]=b},Warden.extend=function(){var a=Utils.each,b=Utils.is,c=Utils.filter,d=Utils.extend,e="addEventListener",f="attachEvent",g={arrays:["pop","push","splice","reverse","shift","unshift","sort"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null},h={},i=function(b){return h[b]=h[b]||[],a(Utils.toArray(arguments).slice(1),function(a){h[b].push(a)}),h[b]},j=function(a){return h[a]||[]};return Warden.configure.changeDefault=function(a){return Utils.extend(g,a)},Warden.configure.natives=function(a){e=a.listener,f=a.altenativeListener},function(h,k){Analyze("extend",h);var l=d({},g,k||{}),m=h||{},n=!0,o=l.names;b.fn(h)?m=h.prototype:(n=!1,b.array(h)&&(a(l.arrays,function(a){h[a]=function(){h.constructor.prototype[a].apply(h,arguments),h.emit({type:a,current:h,data:Utils.toArray(arguments)})}}),d(m,{sequentially:function(a){var b=Warden.makeStream().get(),c=this,d=0,e=setInterval(function(){d==c.length?(d=0,clearInterval(e)):b.fire(c[d++])},a);return b},toBus:function(){var b=Warden.makeStream().bus();return a(m,function(a,c){b.data.last=b.data.takes[c]=b.data.fires[c]=a}),b}})));var p=m[o.emit]||m[o.listen]||m[o.unlisten]||m[o.stream];if(b.exist(p))throw new Error("Can't overwrite: "+(p.name?p.name:p)+" of object");return jQueryInited&&(n?!0:h instanceof jQuery)?(l.emitter=l.emitter||"trigger",l.listener=l.listener||"on"):(b.fn(m[e])||b.fn(m[f]))&&(l.listener=l.listener||(b.fn(m[e])?e:f)),m[o.emit]=function(d,e){var f=this,g=b.str(d)?d:d.type,e=b.obj(d)?d:e||d,h=c(j(this.$$id=this.$$id||Utils.$hash.set("o")),function(a){return a.type==g||(a.rx?a.rx.test(g):!1)});return a(h,function(a){a.callback.call(f,e)}),this},m[o.listen]=function(b,d){var e=this,f=j(this.$$id=this.$$id||Utils.$hash.set("o")),g=function(a,b){var g=c(f,function(b){return b.type==a||(b.rx?b.rx.test(a):!1)});!g.length&&e[l.listener]&&e[l.listener].apply(e,[a,function(a){e.emit(a)}]),i(e.$$id,{type:a,rx:b,callback:d})};return Analyze("listen",b),a(b.split(","),function(a){a=Utils.trim(a),g(a,a.indexOf("*")>=0?new RegExp(a):null)}),this},m[o.unlisten]=function(b,c){var d=j(this.$$id=this.$$id||Utils.$hash.set("o"));return Analyze("unlisten",b),a(b.split(","),function(b){if(b=Utils.trim(b),d.length){var e=[];a(d,function(a,b){a.callback.name==(c.name||c)&&e.push(b)}),a(e,function(a){d.splice(a,1)})}}),this},m[o.stream]=function(b,d){var e=this,f=Warden.makeStream(b,d||this),g=j(this.$$id=this.$$id||Utils.$hash.set("o"));return Analyze("stream",b),a(b.split(","),function(a){a=Utils.trim(a),!c(g,function(b){return b.type==a}).length&&e[l.listener]&&e[l.listener].apply(e,[a,function(a){f.eval(a)}]),i(e.$$id,{type:a,callback:function(a){f.eval(a)}})}),f.get()},h}}(),Warden.makeStream=function(){function a(a,d){var e=[];return{$$id:Utils.$hash.set("s"),$$context:a,$$type:d,eval:function(c){b(e,function(b){b.fire(c,a)})},transform:function(a){c.fn(a)&&(e=Utils.map(e,a))},push:function(a){return e.push(a),a},pushAllUp:function(a){function b(a){c.exist(a.parent)&&(e.push(a.parent),b(a.parent))}e.push(a),b(a)},pushAllDown:function(a){var c=this;b(c.push(a).children,function(a){c.pushAllDown(a)})},pop:function(a){return b(e,function(b,c){a.$$id==b.$$id&&(e=e.slice(0,c).concat(e.slice(c+1,e.length)))}),a},popAllDown:function(a){var c=this;b(c.pop(a).children,function(a){c.popAllDown(a)})},popAllUp:function(a){var b=this.pop(a);c.exist(b.parent)&&this.popAllUp(b.parent)},get:function(){var a=new DataBus;return a.host=this,a},bus:function(){return this.get()}}}var b=Utils.each,c=Utils.is;return function(d,e,f){var g,h,i,j=[];if(Analyze("makeStream",d),e=e||{},g=a(e),c.fn(d)){if(f===!0){h=d.toString();for(i in e)e.hasOwnProperty(i)&&j.push(i);b(j,function(a){h.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",e)})}d.call(e,function(a){g.eval(a)})}return g}}();var DataBus=function(){function a(a,b){a.parent=b,b.children.push(a)}function b(b){var e,g,h=f.get(this.$$id,"processor");return b?(e=[],d(h.process(),function(a){e.push(a)}),e.push(b),g=new c(e),g.host=this.host,a(g,this),g):h}function c(a){var b=this,c=this.$$id=Utils.$hash.set("d");this.parent=null,this.children=[],this.data={fires:new Utils.Queue,takes:new Utils.Queue,last:null},f.set(c,{bindings:[],processor:new Processor(a||[],b),handlers:[],setup:function(a){return a}})}var d=Utils.each,e=Utils.is,f=(Utils.toArray,{set:function(a,b,c){return e.obj(b)&&!e.exist(c)?this[a]=b:this[a][b]=e.fn(c)?c(this[a][b]):c},get:function(a,b){return e.exist(b)?this[a][b]:this[a]}});return c.prototype.bindTo=function(a,b,c){var d=Warden.watcher(this,a,b,c);return f.get(this.$$id,"bindings").push(d),d},c.prototype.update=function(a){var b=f.get(this.$$id,"bindings");b.length&&d(b,function(b){b.update(a||self.data.takes.last())})},c.prototype.fire=function(a,b){var c=this.$$id,g=this;a=f.get(c,"setup")(e.exist(a)?a:{}),this.data.fires.push(a),f.get(c,"processor").start(a,b,function(a){g.data.takes.push(a),g.update(g.data.last=a),d(f.get(c,"handlers"),function(c){c.call(b,a)})})},c.prototype.setup=function(a){Analyze("setup",a),f.set(this.$$id,"setup",function(){return a})},c.prototype.listen=function(a){var b=this;return f.set(this.$$id,"handlers",function(c){return c.push(a),c.length<=1&&b.host.push(b),c}),this},c.prototype.mute=function(a){return a=e.fn(fn)?a.name:a,d(f.get(this.$$id,"handlers"),function(b,c){b.name==a&&f.set(this.$$id,"handlers",function(a){return a.slice(0,c).concat(a.slice(c+1,a.length))})}),this},c.prototype.log=function(a){return this.listen(function(b){console.log(a||b)})},c.prototype.filter=function(a){return Analyze("filter",a),b.call(this,function(b,c){return a.call(this,b)===!0?c.$continue(b):c.$break()})},c.prototype.map=function(a){var c,f=function(b,c){return c.$continue(a)};switch(typeof a){case"function":c=function(b,c){return c.$continue(a.call(this,b))};break;case"string":if(a.indexOf("/")>=0)return this.get(a);c="."==a[0]?function(b,c){var d=b[a.slice(1)],f=e.exist(d)?d:a;return c.$continue(f)}:"@"==a[0]?function(b,c){var d=this[a.slice(1)],f=e.exist(d)?d:a;return c.$continue(f)}:f;break;case"object":c=e.array(a)?function(b,c){var f=[];return d(a,function(a){var c;f.push(e.str(a)&&"."==a[0]&&e.exist(c=b[a.slice(1)])?c:a)}),c.$continue(f)}:function(b,c){var d,f={};for(var g in a)d=b[a[g]],f[g]=e.exist(d)?d:a[g];return c.$continue(f)};break;default:c=f}return b.call(this,c)},c.prototype.nth=function(a){return Analyze("nth",a),b.call(this,function(b,c){return c.$continue(b[a])})},c.prototype.get=function(a){return Analyze("get",a),b.call(this,function(b,c){var f=b;return d(a.split("/"),function(a){var b;if("["==a[0]&&"]"==a[a.length-1]){if(b=a.slice(1,-1),e.exist(b)){if(!e.num(parseInt(b)))throw"Wrong syntax at DataBus.get() method";a=parseInt(b)}}else if(!e.exist(f[a]))throw"Can't find "+a+" property";f=f[a]}),c.$continue(f)})},c.prototype.reduce=function(a,c){return Analyze("reduce",c),1==arguments.length&&(c=a,a=void 0),b.call(this,function(b,d){var e=d.$host(),f=b,g=e.data.takes.length>0?e.data.takes.last():a;return d.$continue(c.call(this,g,f))})},c.prototype.take=function(a){return Analyze("take",a),b.call(this,function(b,c){var d=c.$host();return d.data.limit=d.data.limit||a,d.data.takes.length===d.data.limit?c.$break():c.$continue(b)})},c.prototype.include=function(){{var a=Utils.toArray(arguments);a.length}return b.call(this,function(b,c){var f=c.$host();return d(a,function(a){Analyze("include",a),e.exist(f.data[a])&&(b[a]=f.data[a])}),c.$continue(b)})},c.prototype.skip=function(a){return Analyze("skip",a),b.call(this,function(b,c){return c.$host().data.fires.length>a?c.$continue(b):c.$break()})},c.prototype.interpolate=function(a){return Analyze("interpolate",a),b.call(this,function(b,c){return c.$continue(Utils.interpolate(a,b))})},c.prototype.mask=function(a){return Analyze("mask",a),b.call(this,function(b,c){return c.$continue(e.str(b)?Utils.interpolate(b,a):b)})},c.prototype.unique=function(a){return Analyze("unique",a),a=a||Warden.configure.cmp,b.call(this,function(b,c){var d=c.$host().data,e=d.fires,f=d.takes,g=(e.length>1||f.length>0)&&(a(b,e[e.length-2])||a(b,f.last()));return g?c.$break():c.$continue(b)})},c.prototype.debounce=function(a){return Analyze("debounce",a),b.call(this,function(b,c){var d=c.$host();clearTimeout(d.data.dbtimer),d.data.dbtimer=setTimeout(function(){delete d.data.dbtimer,c.$unlock(),c.$continue(b)},a),c.$lock()})},c.prototype.getCollected=function(a){return Analyze("getCollected",a),b.call(this,function(b,c){{var d=c.$host();d.data.fires.length-1}d.data.tmpCollection=d.data.tmpCollection||[],d.data.tmpCollection.push(b),d.data.timer?c.$lock():(d.data.timer=setTimeout(function(){var a=d.data.tmpCollection;clearTimeout(d.data.timer),delete d.data.timer,delete d.data.tmpCollection,c.$unlock(),c.$continue(a)},a),c.$lock())})},c.prototype.collectFor=function(a){var b=[];return this.listen(function(a){b.push(a)}),Warden.makeStream(function(c){a.listen(function(){c(b),b=[]})}).get()},c.prototype.equals=function(a,b){return b=b||Warden.configure.cmp,this.filter(function(c){return b(a,c)})},c.prototype.delay=function(a){return Analyze("delay",a),b.call(this,function(b,c){setTimeout(function(){c.$continue(b)},a)})},c.prototype.toggle=function(a,c){var d=this;return this.data.toggle=!1,b.call(this,function(b,e){var f=d.data.toggle?a:c;return d.data.toggle=!d.data.toggle,e.$continue(f.call(d,b))})},c.prototype.after=function(a,c){var d=!1;return a.listen(function(){d=!0}),b.call(this,function(a,b){d?(d=c===!0?!1:!0,b.$unlock(),b.$continue(a)):b.$lock()})},c.prototype.repeat=function(b,c){var d=this,e=b,f=Warden.makeStream(function(a){d.listen(function(d){var f=setInterval(function(){b?(a(d),b--):(b=e,clearInterval(f))},c)})}).bus();return a(f,this),f},c.prototype.waitFor=function(a){var b=this;return Warden.makeStream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).bus()},c.prototype.merge=function(){function a(a,b,c){return Warden.makeStream(function(c){a.listen(c),b.listen(c)},c).get()}var b=Utils.toArray(arguments);return b.unshift(this),Utils.reduce(b,function(b,c){return a(b,c,b.host.$$context)})},c.prototype.resolveWith=function(a,b){var c=this,d=this.host.$$context;return Warden.makeStream(function(e){c.sync(a).listen(function(a){e(b.call(d,a[0],a[1]))})},d).bus()},c.prototype.combine=function(a,b,c){var d=this,c=c||this.host.$$context;return Warden.makeStream(function(e){function f(a,d){e(b.call(c,a,d))}d.listen(function(b){f(b,a.data.takes.last)}),a.listen(function(a){f(d.data.last,a)})},c).get()},c.prototype.sync=function(){var b,c=Utils.toArray(arguments),e=[],f=[];return c.unshift(this),b=Warden.makeStream(function(a){d(c,function(b,c){b.listen(function(b){var d=f.length?!0:!1;Utils.forWhile(f,function(a,b){return b==c?!0:(a||(d=!1),a)},!1),e[c]=b,d?a(e):f[c]=!0})})}).bus(),a(b,this),b},c.prototype.syncFlat=function(){var b=this,c=Utils.toArray(arguments),d=Warden.makeStream(function(a){b.sync.apply(b,c).listen(function(b){a.call(this,Utils.flatten(b))})}).bus();return a(d,this),d},c.prototype.lock=function(){this.host.pop(this)},c.prototype.lockChildren=function(){this.host.popAllDown(this)},c.prototype.lockParents=function(){this.host.popAllUp(this)},c.prototype.unlock=function(){this.host.push(this)},c.prototype.unlockChildren=function(){this.host.pushAllDown(this)},c.prototype.unlockParents=function(){function a(b){e.exist(b.parent)&&(b.host.push(b.parent),a(b.parent))}this.host.push(this),a(this)},Warden.configure.addToDatabus=function(a,d,e,f){d=d||a.name,c.prototype[d]=function(){return Analyze(d,arguments[f||0]),b.call(this,a(arguments))}},c}();Warden.watcher=function(){var is=Utils.is,each=Utils.each;return function(bus,a,b){var argv=Utils.toArray(arguments).slice(1,arguments.length),argc=argv.length,fn;if(1===argc)is.str(a)?fn=function(b){this[a]=b}:is.obj(a)?fn=function(b){a=b}:is.fn(a)&&(fn=function(b){a(b)});else if(is.obj(a)&&is.str(b))if(b.indexOf("/")>=0){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:fn=function(c){a[b]=c};else is.fn(b)&&(fn=function(c){b.call(a,c)});return bus.listen(fn),{update:fn,unbind:function(a){bus.mute(a)},bind:function(a){bus.listen(a||fn)}}}}(),jQueryInited&&Warden.extend(jQuery)});