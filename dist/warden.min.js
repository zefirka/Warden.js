!function(a,b){if("object"==typeof exports&&exports)module.exports=b();else{var c=b();"function"==typeof define&&define.amd?define(c):a.Warden=c}}(this,function(){"use strict";function each(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}function forWhile(a,b,c,d){c=c||!1;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return void 0!==d?d:!0}function filter(a,b){var c=[];return each(a,function(a,d){b(a,d)===!0&&c.push(a)}),c}function reduce(a,b){for(var c=a[0],d=1,e=a.length;e>d;d++)c=b(c,a[d]);return c}function map(a,b){var c=[];return each(a,function(a,d){c[d]=b(a,d)}),c}function some(a,b){return forWhile(a,b,!0,!1)}function every(a,b){return forWhile(a,b)}function truthy(a){return a?!0:!1}function typeIs(a){return function(b){return typeof b===a}}function not(a){return function(b){return!a(b)}}function toArray(a){return is.obj(a)&&!is.exist(a.length)&&(a.length=Object.keys(a).length),Array.prototype.slice.call(a)}function extend(){function a(a,b){if(!b||"object"!=typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}return reduce(toArray(arguments),function(b,c){return a(b,c)})}function Pipeline(a,b){function c(a,b){return b?f=0:f==d.length?(f=0,h.fin(a)):(f++,void d[f-1].apply(h.ctx,[a,g]))}var d=a||[],e=0,f=0,g={next:function(a){return c(a)},stop:function(){return f=0},pause:function(){return e=1},play:function(){return e=0},bus:function(){return b}},h={pipe:function(a){return a?(d.push(a),h):d},start:function(a,b,g){return h.ctx=b,h.fin=g,f=e?0:f,f==d.length?(f=0,g(a)):void c(a)}};return h}var Warden=function(a,b){return Warden.extend(a||{},b)},jQueryInited="undefined"!=typeof jQuery;Warden.version="0.3.0-alpha",Warden.configure={cmp:function(a,b){return a===b}};var Utils,_FUN="function",_NUM="number",_STR="string",_OBJ="object",_ARR="array",_BOOL="boolean",_UND="undefined",is={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:typeIs(_FUN),num:typeIs(_NUM),str:typeIs(_STR),bool:typeIs(_BOOL),equals:function(a){return function(b){return a===b}}};is.obj=function(a){return typeIs(_OBJ)(a)&&!is.array(a)};var hashc=function(){var a={};return{get:function(b){return a[b]},set:function(b){return a[b]=((parseInt(a[b],16)||0)+1).toString(16)}}}();Utils={is:is,not:not,forWhile:forWhile,each:each,filter:filter,some:some,every:every,map:map,reduce:reduce,toArray:toArray,interpolate:function(a){var b={},c=arguments.length,d=Utils.toArray(arguments),e=/{{\s*[\w\.\/\[\]]+\s*}}/g;return 2==c&&is.obj(d[1])?b=d[1]:each(d.slice(1,c),function(a,c){b[c]=a}),a.replace(e,function(a){var c=Utils.getObject(b,a.slice(2,-2))||a;return is.obj(c)&&(c=JSON.stringify(c)),c})},flatten:function(a){var b=[];return each(a,function(a){is.array(a)?b=b.concat(Utils.flatten(a)):b.push(a)}),b},extend:extend,trim:function(a){return a.replace(/^\s+|\s+$/g,"")},getObject:function(a,b){return is.obj(a)?(each(b.split("/"),function(b){if(!is.exist(a))return a;var c;if("["==b[0]&&"]"==b[b.length-1]){if(c=b.slice(1,-1),is.exist(c)){if(!is.num(parseInt(c)))throw"Wrong syntax";b=parseInt(c)}}else is.exist(a[b])||(a={});a=a[b]}),a):a},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:hashc},Warden.Utils=Utils,Warden.extend=function(){function a(a){return/.?[\*\[\]\{\}\.\?\$\^\\\|].?/g.test(a)}function b(a){each(a,function(a,b){this[b]=a}.bind(this))}var c="addEventListener",d="attachEvent",e={arrays:["pop","push","splice","reverse","shift","unshift","sort"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null},f={},g=function(a){return f[a]=f[a]||[],each(Utils.toArray(arguments).slice(1),function(b){f[a].push(b)}),f[a]},h=function(a){return f[a]||[]};return function(f,i){function j(a,b,c){return function(d){var e=this;if(every(b,function(a){return is.str(d)?a.type==d:a.type.test(d)})&&e[k.listener]){if(!is.str(d))throw new Error("Invalid format in: "+k.listener);this[k.listener].apply(this,[d,function(b){a.call(e,b)}])}g(e.$$id,{type:d,callback:c})}}var k=extend({},e,i||{}),l=f||{},m=!0,n=k.names;is.fn(f)?l=f.prototype:(m=!1,is.array(f)&&(b.prototype=[],b.prototype.sequentially=function(a){var b=Warden.makeStream(),c=this,d=0,e=setInterval(function(){d==c.length?(d=0,clearInterval(e)):b.eval(c[d++])},a);return b.bus()},each(k.arrays,function(a){b.prototype[a]=function(){var b=this;Array.prototype[a].apply(this,arguments),this.emit({type:a,prev:b,current:this,data:Utils.toArray(arguments)})}}),f=new b(f),l=f));var o=l[n.emit]||l[n.listen]||l[n.unlisten]||l[n.stream];if(is.exist(o))throw new Error("Can't overwrite: "+(o.name?o.name:o)+" of object");return jQueryInited&&(m?!0:f instanceof jQuery)?(k.emitter=k.emitter||"trigger",k.listener=k.listener||"on"):(is.fn(l[c])||is.fn(l[d]))&&(k.listener=k.listener||(is.fn(l[c])?c:d)),l[n.emit]=function(a,b){var c=this,d=is.str(a)?a:a.type,b=is.obj(a)?a:b||a,e=filter(h(this.$$id=this.$$id||hashc.set("o")),function(a){return is.str(a.type)?a.type==d:a.type.test(d)});return each(e,function(a){a.callback.call(c,b)}),this},l[n.listen]=function(b,c){var d=this,e=j(function(a){this.emit(a)},h(this.$$id=this.$$id||hashc.set("o")),c);return each(b.split(","),function(b){b=Utils.trim(b),e.call(d,a(b)?new RegExp(b):b)}),this},l[n.unlisten]=function(a,b){var c=[],a=Utils.trim(a),d=h(this.$$id=this.$$id||hashc.set("o"));return d.length&&(b?each(d,function(d,e){d.callback.name==(b.name||b)&&d.type.toString()==a.toString()&&c.push(e)}):c=new Array(d.length),each(c,function(a){d.splice(a,1)})),this},l[n.stream]=function(b,c){var d=this,e=Warden.makeStream(b,c||this),f=function(a){e.host.eval(a)},g=j(f,h(this.$$id=this.$$id||hashc.set("o")),f);return each(b.split(","),function(b){b=Utils.trim(b),g.call(d,a(b)?new RegExp(b):b)}),e},f}}(),Warden.pipeline=Pipeline,Warden.Stream=function(){function a(a){var b=[];return{$$context:a,eval:function(c){each(b,function(b){b.fire(c,a)})},push:function(a){return b.push(a),a},newBus:function(){var a=new DataBus;return a.host=this,a}}}return Warden.Host=a,function(b,c,d){var e,f,g,h,i=[];if(c=c||{},e=a(c),is.fn(b)){if(d===!0){f=b.toString();for(g in c)c.hasOwnProperty(g)&&i.push(g);each(i,function(a){f.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",c)})}b.call(c,function(a){e.eval(a)})}return h=new DataBus,h.host=e,h}}(),Warden.makeStream=Warden.Stream;var DataBus=function(){function a(a,b){return a.parent=b,b.children.push(a),a}function b(b){var d,f=e[this.$$id],g=[];return b?(each(f.pipe(),function(a){g.push(a)}),g.push(b),d=new c(g),d.host=this.host,a(d,this)):f}function c(a){this.$$id=Utils.$hash.set("d"),this.parent=null,this.children=[],this.bindings=[],d[this.$$id]=[],e[this.$$id]=Pipeline(a||[],this),this.data={fires:new Utils.Queue(4),takes:new Utils.Queue(4),last:null}}var d={},e={};return Utils.extend(c.prototype,{bindTo:function(){var a=Warden.watcher.apply(null,[this].concat(toArray(arguments)));return this.bindings.push(a),a},update:function(a){var b=this;each(this.bindings,function(c){c.update(a||b.data.takes.last())})},fire:function(a,b){if(!this.locked){var c=this.$$id,f=this;this.data.fires.push(a),e[c].start(a,b,function(a){f.data.takes.push(a),f.update(f.data.last=a),each(d[c],function(c){c.call(b,a)})})}},listen:function(a){var b=this,c=d[this.$$id];return c.push(a),c.length<=1&&b.host.push(b),this},watch:function(){return this.host.push(this),this},mute:function(a){return a=is.fn(a)?a.name:a,Utils.forWhile(d[this.$$id],function(b,c){return b.name==a?(d[this.$$id].splice(c,1),!1):void 0},!1),this},log:function(a){return this.listen(function(b){console.log(a||b)})},filter:function(a){return b.call(this,function(b,c){return a.call(this,b)===!0?c.next(b):c.stop()})},map:function(a){var c,d=function(b,c){return c.next(a)};switch(typeof a){case"function":c=function(b,c){return c.next(a.call(this,b))};break;case"string":if(a.indexOf("/")>=0)return this.get(a);c="."==a[0]?function(b,c){var d=a.indexOf("()")>0?b[a.slice(1,-2)]:b[a.slice(1)],e=is.exist(d)?d:a,f=e;return is.fn(e)&&a.indexOf("()")>0&&(f=e()),c.next(f)}:"@"==a[0]?1==a.length?function(a,b){b.next(this)}:function(b,c){var d=a.indexOf("()")>0?this[a.slice(1,-2)]:this[a.slice(1)],e=is.exist(d)?d:a,f=e;return is.fn(e)&&a.indexOf("()")>0&&(f=e.call(this)),c.next(f)}:d;break;case"object":c=is.array(a)?function(b,c){var d=[];return each(a,function(a){var c;d.push(is.str(a)&&"."==a[0]&&is.exist(c=b[a.slice(1)])?c:a)}),c.next(d)}:function(b,c){var d,e,f={};for(var g in a)e=a[g],0==e.indexOf(".")&&b[e.slice(1)]&&(d=b[e.slice(1)]),0==e.indexOf("@")&&(this[e.slice(1)]||this[e.slice(1,-2)])&&(d=e.indexOf("()")>0?this[e.slice(1,-2)]():this[e.slice(1)]),f[g]=d;return c.next(f)};break;default:c=d}return b.call(this,c)},nth:function(a){return b.call(this,function(b,c){return c.next(b[a+1])})},get:function(a){return b.call(this,function(b,c){return c.next(Utils.getObject(b,a))})},reduce:function(a,c){return b.call(this,function(b,d){var e=d.bus();return d.next(0!=e.data.takes.length||is.exist(a)?c.call(this,e.data.takes.last()||a,b):b)})},take:function(a){return b.call(this,function(b,c){var d=c.bus();return d.data.limit=d.data.limit||a,d.data.taken=d.data.taken+1||0,d.data.taken>=d.data.limit?c.stop():c.next(b)})},skip:function(a){return b.call(this,function(b,c){return c.bus().data.fires.length>a?c.next(b):c.stop()})},interpolate:function(a){return b.call(this,function(b,c){return c.next(Utils.interpolate(a,b))})},mask:function(a){return b.call(this,function(b,c){return c.next(is.str(b)?Utils.interpolate(b,a):b)})},unique:function(a){return a=a||Warden.configure.cmp,b.call(this,function(b,c){var d=c.bus().data,e=d.fires,f=d.takes,g=(e.length>1||f.length>0)&&(a(b,e[e.length-2])||a(b,f.last()));return g?c.stop():c.next(b)})},debounce:function(a){return b.call(this,function(b,c){var d=c.bus();clearTimeout(d.data.dbtimer),d.data.dbtimer=setTimeout(function(){delete d.data.dbtimer,c.play(),c.next(b)},a),c.pause()})},getCollected:function(a){return b.call(this,function(b,c){{var d=c.bus();d.data.fires.length-1}d.data.tmpCollection=d.data.tmpCollection||[],d.data.tmpCollection.push(b),d.data.timer?c.pause():(d.data.timer=setTimeout(function(){var a=d.data.tmpCollection;clearTimeout(d.data.timer),delete d.data.timer,delete d.data.tmpCollection,c.play(),c.next(a)},a),c.pause())})},filterFor:function(a){var c=null;return b.call(this,function(b,d){var e={get:function(a){return a?a(c):c},next:function(a){c=a,d.next(a)},stop:function(){d.stop()}};return a(b,e)})},collectFor:function(a){var b=[];return this.listen(function(a){b.push(a)}),Warden.makeStream(function(c){a.listen(function(){c(b),b=[]})}).bus()},equals:function(a,b){return b=b||Warden.configure.cmp,this.filter(function(c){return b(a,c)})},delay:function(a){return b.call(this,function(b,c){setTimeout(function(){c.next(b)},a)})},toggle:function(a,b){var c=!1;return this.listen(function(d){c?a.call(this,d):b.call(this,d),c=!c})},after:function(a,c){var d=!1;return a.listen(function(){d=!0}),b.call(this,function(a,b){d?(d=c===!0?!1:!0,b.play(),b.next(a)):b.pause()})},repeat:function(b,c){var d=this,e=b,f=Warden.makeStream(function(a){d.listen(function(d){var f=setInterval(function(){b?(a(d),b--):(b=e,clearInterval(f))},c)})}).bus();return a(f,this)},waitFor:function(a){var b=this;return Warden.makeStream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).bus()},merge:function(){var b=Warden.Host(this.host.$$context),c=Utils.toArray(arguments);return c.push(this),each(c,function(a){a.listen(function(a){b.eval(a)})}),a(b.newBus(),this)},resolveWith:function(a,b){var c=this,d=this.host.$$context;return Warden.makeStream(function(e){c.sync(a).listen(function(a){e(b.call(d,a[0],a[1]))})},d).bus()},combine:function(a,b,c){var d=this,e=this.host.$$context;return Warden.makeStream(function(f){function g(a,c){f(b.call(e,a,c))}d.listen(function(b){g(b,a.data.last||c)}),a.listen(function(a){g(d.data.last||c,a)})},e).bus()},sync:function(){var b,c=Utils.toArray(arguments),d=[],e=[];return c.unshift(this),d.length=e.length=c.length,b=Warden.makeStream(function(a){each(c,function(b,f){b.listen(function(b){var g=e.length?!0:!1;Utils.forWhile(e,function(a,b){return b==f?!0:(a||(g=!1),a)},!1),d[f]=b,g?(a(d),d=[],e=[],d.length=e.length=c.length):e[f]=!0})})}).bus(),a(b,this)},syncFlat:function(){var b=this,c=Utils.toArray(arguments),d=Warden.makeStream(function(a){b.sync.apply(b,c).listen(function(b){a.call(this,Utils.flatten(b))})}).bus();return a(d,this)},lock:function(){function a(b){b.locked=!0,each(b.children,a)}a(this)},lockParents:function(){unlock(this)},bus:function(){var a=new c;return a.host=this.host,a},unlock:function(){this.locked=!1},unlockChildren:function(){function a(b){b.locked=!1,each(b.children,a)}a(this)}}),Warden.configure.addToDatabus=function(a,d){d=d||a.name,c.prototype[d]=function(){return b.call(this,a(arguments))}},c}();return Warden.watcher=function(){var argv=Utils.toArray(arguments).slice(1,arguments.length),argc=argv.length,bus=arguments[0],a=argv[0],b=argv[1],fn,st;if(1===argc)is.str(a)?fn=function(b){this[a]=b}:is.fn(a)&&(fn=function(b){a(b)});else if(is.obj(a)&&is.str(b))if(b.indexOf("/")>=0){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:fn=function(c){a[b]=c};else is.fn(b)&&(fn=function(c){b.call(a,c)});return st=fn,bus.watch(),{update:fn,unbind:function(){st=fn,fn=function(){}},bind:function(){fn=st}}},Warden.Worker=function(a){a=".js"==a.slice(-3)?a:a+".js";var b=new Worker(a),c=Warden.Stream(function(a){b.onmessage=a});return c.post=b.postMessage,c.onmessage=b.onmessage,c},jQueryInited&&Warden.extend(jQuery),Warden});