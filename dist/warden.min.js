!function(a,b){if("object"==typeof exports&&exports)module.exports=b();else{var c=b();"function"==typeof define&&define.amd?define(c):a.Warden=c}}(this,function(){"use strict";function each(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}function forWhile(a,b,c,d){c=c||!1;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return void 0!==d?d:!0}function filter(a,b){var c=[];return each(a,function(a,d){b(a,d)===!0&&c.push(a)}),c}function heach(a,b){for(var c in a)b(a[c],c)}function reduce(a,b){for(var c=a[0],d=1,e=a.length;e>d;d++)c=b(c,a[d]);return c}function map(a,b){var c=[];return each(a,function(a,d){c[d]=b(a,d)}),c}function some(a,b){return forWhile(a,b,!0,!1)}function every(a,b){return forWhile(a,b)}function truthy(a){return a?!0:!1}function typeIs(a){return function(b){return typeof b===a}}function trim(a){return a.replace(/^\s+|\s+$/g,"")}function not(a){return function(b){return!a(b)}}function toArray(a){return is.obj(a)&&!is.exist(a.length)&&(a.length=Object.keys(a).length),Array.prototype.slice.call(a)}function extend(){function a(a,b){if(!b||"object"!=typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}return reduce(toArray(arguments),function(b,c){return a(b,c)})}function Pipeline(a,b){function c(a,b){return b?f=0:f==d.length?(f=0,h.fin(a)):(f++,void d[f-1].apply(h.ctx,[a,g]))}var d=a||[],e=0,f=0,g={next:function(a){return c(a)},stop:function(){return f=0},pause:function(){return e=1},play:function(){return e=0},bus:function(){return b}},h={pipe:function(a){return a?(d.push(a),h):d},start:function(a,b,g){return h.ctx=b,h.fin=g,f=e?0:f,f==d.length?(f=0,g(a)):void c(a)}};return h}var Warden=function(a,b){return Warden.extend(a||{},b)},jQueryInited="undefined"!=typeof jQuery;Warden.version="0.3.0",Warden.configure={cmp:function(a,b){return a===b}};var Utils,_FUN="function",_NUM="number",_STR="string",_OBJ="object",_ARR="array",_BOOL="boolean",_UND="undefined",is={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:typeIs(_FUN),num:typeIs(_NUM),str:typeIs(_STR),bool:typeIs(_BOOL),equals:function(a){return function(b){return a===b}}};is.obj=function(a){return typeIs(_OBJ)(a)&&!is.array(a)};var hashc=function(){var a={};return{get:function(b){return a[b]},set:function(b){return a[b]=((parseInt(a[b],16)||0)+1).toString(16)}}}();Utils={is:is,not:not,forWhile:forWhile,each:each,filter:filter,some:some,every:every,map:map,reduce:reduce,toArray:toArray,interpolate:function(a){var b={},c=arguments.length,d=Utils.toArray(arguments),e=/{{\s*[\w\.\/\[\]]+\s*}}/g;return 2==c&&is.obj(d[1])?b=d[1]:each(d.slice(1,c),function(a,c){b[c]=a}),a.replace(e,function(a){var c=Utils.getObject(b,a.slice(2,-2)),d=is.exist(c)?c:a;return is.obj(d)&&(d=JSON.stringify(d)),d})},flatten:function(a){var b=[];return each(a,function(a){is.array(a)?b=b.concat(Utils.flatten(a)):b.push(a)}),b},extend:extend,trim:trim,getObject:function(a,b){return is.obj(a)?(each(b.split("/"),function(b){if(!is.exist(a))return a;var c;if("["==b[0]&&"]"==b[b.length-1]){if(c=b.slice(1,-1),is.exist(c)){if(!is.num(parseInt(c)))throw"Wrong syntax";b=parseInt(c)}}else is.exist(a[b])||(a={});a=a[b]}),a):a},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:hashc},Warden.Utils=Utils,Warden.extend=function(){function a(a){return/.?[\*\[\]\{\}\.\?\$\^\\\|].?/g.test(a)}function b(a){each(a,function(a,b){this[b]=a}.bind(this))}var c="addEventListener",d="attachEvent",e={arrays:["pop","push","splice","reverse","shift","unshift","sort"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null},f={},g=function(a){f[a]=f[a]||[],each(toArray(arguments).slice(1),function(b){f[a].push(b)})},h=function(a){return f[a]||[]};return function(f,i){function j(a,b,c){return function(d){var e=this;if(every(b,function(a){return is.str(d)?a.type==d:a.type.test(d)})&&e[k.listener]){if(!is.str(d))throw new Error("Invalid format in: "+k.listener);this[k.listener].apply(this,[d,function(b){a.call(e,b)}])}g(e.$$id,{type:d,callback:c})}}var k=extend({},e,i||{}),l=f||{},m=!0,n=k.names;is.fn(f)?l=f.prototype:(m=!1,is.array(f)&&(b.prototype=[],b.prototype.sequentially=function(a){var b=Warden.makeStream(),c=this,d=0,e=setInterval(function(){d==c.length?(d=0,clearInterval(e)):b.eval(c[d++])},a);return b.bus()},each(k.arrays,function(a){b.prototype[a]=function(){var b=this;Array.prototype[a].apply(this,arguments),this.emit({type:a,prev:b,current:this,data:toArray(arguments)})}}),f=new b(f),l=f));var o=l[n.emit]||l[n.listen]||l[n.unlisten]||l[n.stream];if(is.exist(o))throw new Error("Can't overwrite: "+(o.name?o.name:o)+" of object");return jQueryInited&&(m?!0:f instanceof jQuery)?(k.emitter=k.emitter||"trigger",k.listener=k.listener||"on"):(is.fn(l[c])||is.fn(l[d]))&&(k.listener=k.listener||(is.fn(l[c])?c:d)),l[n.emit]=function(a,b){var c=this,d=is.str(a)?a:a.type,b=is.obj(a)?a:b||a,e=filter(h(this.$$id=this.$$id||hashc.set("o")),function(a){return is.str(a.type)?a.type==d:a.type.test(d)});return each(e,function(a){a.callback.call(c,b)}),this},l[n.listen]=function(b,c){var d=this,e=j(function(a){this.emit(a)},h(this.$$id=this.$$id||hashc.set("o")),c);return each(b.split(","),function(b){b=trim(b),e.call(d,a(b)?new RegExp(b):b)}),this},l[n.unlisten]=function(a,b){var c=[],a=trim(a),d=h(this.$$id=this.$$id||hashc.set("o"));return d.length&&(b?each(d,function(d,e){d.callback.name==(b.name||b)&&d.type.toString()==a.toString()&&c.push(e)}):c=new Array(d.length),each(c,function(a){d.splice(a,1)})),this},l[n.stream]=function(b,c){var d=this,e=Warden.makeStream(b,c||this),f=function(a){e.host.eval(a)},g=j(f,h(this.$$id=this.$$id||hashc.set("o")),f);return each(b.split(","),function(b){b=trim(b),g.call(d,a(b)?new RegExp(b):b)}),e},f}}(),Warden.Pipeline=Pipeline,Warden.Stream=function(){function a(a){var b=[];return{$$context:a,eval:function(c){each(b,function(b){b.fire(c,a)})},push:function(a){return b.push(a),a},newBus:function(){var a=new DataBus;return a.host=this,a}}}return Warden.Host=a,function(b,c,d){var e,f,g,h,i=[];if(c=c||{},e=a(c),is.fn(b)){if(d===!0){f=b.toString();for(g in c)c.hasOwnProperty(g)&&i.push(g);each(i,function(a){f.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",c)})}b.call(c,function(a){e.eval(a)})}return h=new DataBus,h.host=e,h}}(),Warden.makeStream=Warden.Stream;var DataBus=function(){function inheritFrom(a,b){return a.parent=b,b.children.push(a),a}function process(a){var b,c=pipes[this.$$id],d=[];return each(c.pipe(),function(a){d.push(a)}),d.push(a),b=new DataBus(d),b.host=this.host,inheritFrom(b,this)}function DataBus(a){this.$$id=Utils.$hash.set("d"),this.parent=null,this.children=[],handlers[this.$$id]=[],pipes[this.$$id]=Pipeline(a||[],this),this.data={fires:new Utils.Queue(3),takes:new Utils.Queue(3),last:null}}var handlers={},pipes={};return Utils.extend(DataBus.prototype,{bindTo:function(){var a=Warden.Watcher.apply(null,[this].concat(toArray(arguments)));return this.bindings.push(a),a},fire:function(a,b){if(!this.locked){var c=this.$$id,d=this;this.data.fires.push(a),pipes[c].start(a,b,function(a){d.data.takes.push(a),each(handlers[c],function(c){c.call(b,a)})})}},listen:function(a){var b=this,c=handlers[this.$$id];return c.push(a),c.length<=1&&b.host.push(b),this},watch:function(){return this.host.push(this),this},mute:function(a){var b=this;return Utils.forWhile(handlers[this.$$id],function(c,d){return(is.fn(a)?c==a:c.name==a)?(handlers[b.$$id].splice(d,1),!1):void 0},!1),this},clear:function(){handlers[this.$$id]=[]},log:function(a){return this.listen(function(b){console.log(a||b)})},filter:function(a){return is.fn(a)?process.call(this,function(b,c){return a.call(this,b)===!0?c.next(b):c.stop()}):process.call(this,function(b,c){return Warden.configure.cmp(a,b)===!0?c.next(b):c.stop()})},map:function(x){function parseEval(string){var res="";return res+=string.indexOf("@")>=0?"@"==string?"this":string.replace("@","this."):string.indexOf(".")>=0?"."==string?"event":string.replace(".","event."):"'"+string+"'",res.match(/\(.+\)/)&&(res=res.replace(/\(.+\)/,function(args){return"("+eval(args.slice(1,-1))+")"})),res}function map(i,event){return is.fn(i)?i.call(this,event):is.str(i)?eval(parseEval(i)):i}var fn=function(a,b){return b.next(x)};return fn="object"==typeof x?is.array(x)?function(a,b){var c=[],d=this;return each(x,function(b){c.push(map.call(d,b,a))}),b.next(c)}:function(a,b){var c={};for(var d in x)c[d]=map.call(this,x[d],a);return b.next(c)}:function(a,b){return b.next(map.call(this,x,a))},process.call(this,fn)},nth:function(a){return process.call(this,function(b,c){return c.next(b[a+1])})},get:function(a){return process.call(this,function(b,c){return c.next(Utils.getObject(b,a))})},reduce:function(a,b){return process.call(this,function(c,d){var e=d.bus();return d.next(0!=e.data.takes.length||is.exist(a)?(b||a).call(this,e.data.takes.last()||(b?a:null),c):c)})},take:function(a){return process.call(this,function(b,c){var d=c.bus();return d.data.limit=d.data.limit||a,d.data.taken=d.data.taken+1||0,d.data.taken>=d.data.limit?c.stop():c.next(b)})},skip:function(a){return process.call(this,function(b,c){return c.bus().data.fires.length>a?c.next(b):c.stop()})},interpolate:function(a){return process.call(this,function(b,c){return c.next(Utils.interpolate(a,b))})},mask:function(a){return process.call(this,function(b,c){return c.next(is.str(b)?Utils.interpolate(b,a):b)})},diff:function(a){return a=a||Warden.configure.cmp,process.call(this,function(b,c){var d=c.bus().data,e=d.fires,f=d.takes,g=(e.length>1||f.length>0)&&(a(b,e[e.length-2])||a(b,f.last()));return g?c.stop():c.next(b)})},debounce:function(a){return process.call(this,function(b,c){var d=c.bus();clearTimeout(d.data.dbtimer),d.data.dbtimer=setTimeout(function(){delete d.data.dbtimer,c.play(),c.next(b)},a),c.pause()})},collect:function(a){return process.call(this,function(b,c){{var d=c.bus();d.data.fires.length-1}d.data.tmpCollection=d.data.tmpCollection||[],d.data.tmpCollection.push(b),d.data.timer?c.pause():(d.data.timer=setTimeout(function(){var a=d.data.tmpCollection;clearTimeout(d.data.timer),delete d.data.timer,delete d.data.tmpCollection,c.play(),c.next(a)},a),c.pause())})},filterFor:function(a){var b=null;return process.call(this,function(c,d){var e={get:function(a){return a?a(b):b},next:function(a){b=a,d.next(a)},stop:function(){d.stop()}};return a(c,e)})},collectFor:function(a){var b=[];return this.listen(function(a){b.push(a)}),Warden.Stream(function(c){a.listen(function(){c(b),b=[]})})},delay:function(a){return process.call(this,function(b,c){setTimeout(function(){c.next(b)},a)})},toggle:function(a,b){var c=!1;return this.listen(function(d){c?b.call(this,d):a.call(this,d),c=!c})},after:function(a,b){var c=!1;return a.listen(function(){c=!0}),process.call(this,function(a,d){c?(c=b===!0?!1:!0,d.play(),d.next(a)):d.pause()})},repeat:function(a,b){var c=this,d=a;return inheritFrom(Warden.Stream(function(e){c.listen(function(c){var f=setInterval(function(){a?(e(c),a--):(a=d,clearInterval(f))},b)})}),this)},waitFor:function(a){var b=this;return Warden.Stream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).bus()},merge:function(){var a=Warden.Host(this.host.$$context),b=Utils.toArray(arguments);return b.push(this),each(b,function(b){b.listen(function(b){a.eval(b)})}),inheritFrom(a.newBus(),this)},alternately:function(a){var b=this,c=0;return Warden.Stream(function(d){b.listen(function(a){0==c&&(d(a),c=1)}),a.listen(function(a){1==c&&(d(a),c=0)})})},resolve:function(a,b,c){var d=this,c=c||this.host.$$context;return Warden.Stream(function(e){d.sync(a).listen(function(a){e(b.call(c,a[0],a[1]))})},c)},combine:function(a,b,c){var d=this,e=this.host.$$context;return Warden.Stream(function(f){function g(a,c){f(b.call(e,a,c))}d.listen(function(b){g(b,a.data.takes.last()||c)}),a.listen(function(a){g(d.data.takes.last()||c,a)})},e).bus()},sync:function(){var a,b=Utils.toArray(arguments),c=[],d=[];return b.unshift(this),c.length=d.length=b.length,a=Warden.Stream(function(a){each(b,function(e,f){e.listen(function(e){var g=d.length?!0:!1;Utils.forWhile(d,function(a,b){return b==f?!0:(a||(g=!1),a)},!1),c[f]=e,g?(a(c),c=[],d=[],c.length=d.length=b.length):d[f]=!0})})}),inheritFrom(a,this)},bus:function(){var a=new DataBus;return a.host=this.host,a},swap:function(a){function b(a,c){a.locked=!c,each(a.children,b)}b(this,a)},toggleOn:function(a,b){a instanceof DataBus&&a.listen(function(){a.swap(b)})},lock:function(a){return this.swap(!1),a&&this.toggleOn(a,!1),this},lockThis:function(){return this.locked=!0,this},unlockThis:function(){return this.locked=!1,this},unlock:function(a){return this.swap(!0),a&&this.toggleOn(a,!0),this}}),Warden.configure.addToDatabus=function(a,b,c){DataBus.prototype[a]=function(){return c?b.apply(this,arguments):process.call(this,b.apply(this,arguments))}},Warden.configure.isStream=function(a){return a instanceof DataBus},DataBus}();return Warden.Watcher=function(){var argv=Utils.toArray(arguments).slice(1,arguments.length),argc=argv.length,bus=arguments[0],a=argv[0],b=argv[1],fn,st;if(1===argc)is.str(a)?fn=function(b){this[a]=b}:is.fn(a)&&(fn=function(b){a(b)});else if(is.obj(a)&&is.str(b))if(b.indexOf("/")>=0){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function binding(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:fn=function(c){a[b]=c};else is.fn(b)&&(fn=function(c){b.call(a,c)});return st=fn,bus.listen(fn),{update:fn,remove:function(){bus.mute("binding")}}},Warden.Worker=function(a){a=".js"==a.slice(-3)?a:a+".js";var b=new Worker(a),c=Warden.Host();return b.onmessage=function(){c.eval(arguments)},c.post=b.postMessage,c.onmessage=b.onmessage,c.newBust()},Warden.Observe=function(a){if(Object.observe){var b=Warden.Host(a);return Object.observe(a,function(){b.eval.apply(a,arguments)}),b.newBus()}throw"This browser doesn't implement Object.observe"},jQueryInited&&Warden(jQuery),Warden});