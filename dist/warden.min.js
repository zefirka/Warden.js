!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(Warden){"use strict";function Pipeline(a,b){var c=a||[],d=0,e=0,f={next:function(a){return g.tick(a)},stop:function(){return g.tick({},1)},pause:function(){return d=1},play:function(){return d=0},bus:function(){return b}},g={pipe:function(a){return a?(c.push(a),g):c},start:function(a,b,f){return g.ctx=b,g.fin=f,e=d?0:e,e==c.length?(e=0,f(a)):void this.tick(a)},tick:function(a,b){return b?e=0:e==c.length?(e=0,g.fin(a)):(e++,void c[e-1].apply(g.ctx,[a,f]))}};return g}var jQueryInited="undefined"!=typeof jQuery;Warden.version="0.2.0-prerelease",Warden.configure={cmp:function(a,b){return a===b}};var Utils,Analyze;!function(){var a="function",b="number",c="string",d="object",e="array",f="boolean",g="undefined";Utils=function(){function e(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}function g(a,b,c,d){c=c||!1;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return void 0!==d?d:!0}function h(a,b){var c=[];return e(a,function(a,d){b(a,d)===!0&&c.push(a)}),c}function i(a,b){for(var c=a[0],d=1,e=a.length;e>d;d++)c=b(c,a[d]);return c}function j(a,b){var c=[];return e(a,function(a,d){c[d]=b(a,d)}),c}function k(a,b){return g(a,b,!0,!1)}function l(a,b){return g(a,b)}function m(a){return a?!0:!1}function n(a){return function(b){return typeof b===a}}function o(a){return function(b){return!a(b)}}var p={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:n(a),num:n(b),str:n(c),bool:n(f),truthy:m,falsee:o(m),equals:function(a){return function(b){return a===b}}};return p.obj=function(a){return n(d)(a)&&!p.array(a)},p.not=function(){var a={};for(var b in p)a[b]=o(p[b]);return a}(),{is:p,not:o,forEach:e,forWhile:g,each:e,filter:h,some:k,every:l,map:j,reduce:i,toArray:function(a){return p.obj(a)&&p.not.exist(a.length)&&(a.length=Object.keys(a).length),Array.prototype.slice.call(a)},interpolate:function(a){var b={},c=arguments.length,d=Utils.toArray(arguments),f=/{{\s*[\w\.\/\[\]]+\s*}}/g;return 2==c&&p.obj(d[1])?b=d[1]:e(d.slice(1,c),function(a,c){b[c]=a}),a.replace(f,function(a){var c=Utils.getObject(b,a.slice(2,-2))||a;return p.obj(c)&&(c=JSON.stringify(c)),c})},log:function(){console.log(this.interpolate.apply(this,arguments))},flatten:function(a){var b=[];return e(a,function(a){p.array(a)?b=b.concat(Utils.flatten(a)):b.push(a)}),b},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},extend:function(){function a(a,b){if(!b||"object"!=typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a}return Utils.toArray(arguments).reduce(function(b,c){return a(b,c)})},getObject:function(a,b){return p.obj(a)?(e(b.split("/"),function(b){if(!p.exist(a))return a;var c;if("["==b[0]&&"]"==b[b.length-1]){if(c=b.slice(1,-1),p.exist(c)){if(!p.num(parseInt(c)))throw"Wrong syntax";b=parseInt(c)}}else p.exist(a[b])||(a={});a=a[b]}),a):a},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:function(){var a={};return{get:function(b){return a[b]},set:function(b){return a[b]=((parseInt(a[b],16)||0)+1).toString(16)}}}()}}(),Analyze=function(a){return function(b,c){var d=a[b],e=Utils.is.exist(d)?Utils.some(d,function(a){return typeof c===a}):!0;if(!e)throw"TypeError: invalid arg in: ."+b+"(). Expected: "+d.join(" or ")+". Your argument is type of: "+typeof c}}({extend:[d,a,e],listen:[c],stream:[c],unlisten:[c],reduce:[a],include:[d,a],take:[b],filter:[a],skip:[b],setup:[a],makeStream:[g,c,a,e],debounce:[b],getCollected:[b],interpolate:[c],mask:[g,d],unique:[a,g],lock:[c],nth:[b],get:[c]})}(),Warden.Utils=Utils,Warden.configure.datatypes=function(a,b){if(Analyze.MAP[a])throw"This name is already exist";Analyze.MAP[a]=b},Warden.extend=function(){function a(a){return/.?[\*\[\]\{\}\.\?\$\^\\\|].?/g.test(a)}var b=Utils.each,c=Utils.is,d=Utils.filter,e=Utils.extend,f=Utils.$hash,g="addEventListener",h="attachEvent",i={arrays:["pop","push","splice","reverse","shift","unshift","sort"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null},j={},k=function(a){return j[a]=j[a]||[],b(Utils.toArray(arguments).slice(1),function(b){j[a].push(b)}),j[a]},l=function(a){return j[a]||[]};return function(j,m){function n(a,b,e){return function(f){var g=this;if(!d(b,function(a){return c.str(f)?a.type==f:a.type.test(f)}).length&&g[o.listener]){if(c.not.str(f))throw new Error("Invalid format in: "+o.listener);this[o.listener].apply(this,[f,function(b){a.call(g,b)}])}k(g.$$id,{type:f,callback:e})}}Analyze("extend",j);var o=e({},i,m||{}),p=j||{},q=!0,r=o.names;c.fn(j)?p=j.prototype:(q=!1,c.array(j)&&(b(o.arrays,function(a){j[a]=function(){j.constructor.prototype[a].apply(j,arguments),j.emit({type:a,current:j,data:Utils.toArray(arguments)})}}),p.sequentially=function(a){var b=Warden.makeStream(),c=this,d=0,e=setInterval(function(){d==c.length?(d=0,clearInterval(e)):b.eval(c[d++])},a);return b.bus()}));var s=p[r.emit]||p[r.listen]||p[r.unlisten]||p[r.stream];if(c.exist(s))throw new Error("Can't overwrite: "+(s.name?s.name:s)+" of object");return jQueryInited&&(q?!0:j instanceof jQuery)?(o.emitter=o.emitter||"trigger",o.listener=o.listener||"on"):(c.fn(p[g])||c.fn(p[h]))&&(o.listener=o.listener||(c.fn(p[g])?g:h)),p[r.emit]=function(a,e){var g=this,h=c.str(a)?a:a.type,e=c.obj(a)?a:e||a,i=d(l(this.$$id=this.$$id||f.set("o")),function(a){return c.str(a.type)?a.type==h:a.type.test(h)});return b(i,function(a){a.callback.call(g,e)}),this},p[r.listen]=function(c,d){var e=this,g=n(function(a){this.emit(a)},l(this.$$id=this.$$id||f.set("o")),d);return Analyze("listen",c),b(c.split(","),function(b){b=Utils.trim(b),g.call(e,a(b)?new RegExp(b):b)}),this},p[r.unlisten]=function(a,d){var e=l(this.$$id=this.$$id||f.set("o"));return Analyze("unlisten",a),b(a.split(","),function(a){if(a=Utils.trim(a),e.length){var f=[];b(e,function(b,e){b.callback.name==(d.name||d)&&(c.str(b.type)?b.type==a:b.type.test(a))&&f.push(e)}),b(f,function(a){e.splice(a,1)})}}),this},p[r.stream]=function(c,d){Analyze("stream",c);var e=this,g=Warden.makeStream(c,d||this),h=function(a){g.eval(a)},i=n(h,l(this.$$id=this.$$id||f.set("o")),h);return b(c.split(","),function(b){b=Utils.trim(b),i.call(e,a(b)?new RegExp(b):b)}),g.bus()},j}}(),Warden.pipeline=Pipeline,Warden.makeStream=function(){function a(a,d){var e=[];return{$$id:Utils.$hash.set("s"),$$context:a,$$type:d,eval:function(c){b(e,function(b){b.fire(c,a)})},push:function(a){return e.push(a),a},pushAllUp:function(a){function b(a){c.exist(a.parent)&&(e.push(a.parent),b(a.parent))}e.push(a),b(a)},pushAllDown:function(a){var c=this;b(c.push(a).children,function(a){c.pushAllDown(a)})},pop:function(a){return Utils.forWhile(e,function(b,c){return a.$$id==b.$$id?(e.splice(c,1),!1):void 0},!1),a},popAllDown:function(a){var c=this;b(c.pop(a).children,function(a){c.popAllDown(a)})},popAllUp:function(a){var b=this.pop(a);c.exist(b.parent)&&this.popAllUp(b.parent)},bus:function(){var a=new DataBus;return a.host=this,a}}}var b=Utils.each,c=Utils.is;return function(d,e,f){var g,h,i,j=[];if(Analyze("makeStream",d),e=e||{},g=a(e),c.fn(d)){if(f===!0){h=d.toString();for(i in e)e.hasOwnProperty(i)&&j.push(i);b(j,function(a){h.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",e)})}d.call(e,function(a){g.eval(a)})}return g}}();var DataBus=function(){function a(a,b){return a.parent=b,b.children.push(a),a}function b(b){var e,f=h[this.$$id],g=[];return b?(d(f.pipe(),function(a){g.push(a)}),g.push(b),e=new c(g),e.host=this.host,a(e,this)):f}function c(a){this.$$id=Utils.$hash.set("d"),this.parent=null,this.children=[],this.bindings=[],g[this.$$id]=[],h[this.$$id]=Pipeline(a||[],this),this.data={fires:new Utils.Queue,takes:new Utils.Queue,last:null}}var d=Utils.each,e=Utils.is,f=Utils.toArray,g={},h={};return c.prototype.bindTo=function(){var a=Warden.watcher.apply(null,[this].concat(f(arguments)));return this.bindings.push(a),a},c.prototype.update=function(a){var b=this;d(this.bindings,function(c){c.update(a||b.data.takes.last())})},c.prototype.fire=function(a,b){var c=this.$$id,e=this;this.data.fires.push(a),h[c].start(a,b,function(a){e.data.takes.push(a),e.update(e.data.last=a),d(g[c],function(c){c.call(b,a)})})},c.prototype.listen=function(a){var b=this,c=g[this.$$id];return c.push(a),c.length<=1&&b.host.push(b),this},c.prototype.watch=function(){return this.host.push(this),this},c.prototype.mute=function(a){return a=e.fn(a)?a.name:a,Utils.forWhile(g[this.$$id],function(b,c){return b.name==a?(g[this.$$id].splice(c,1),!1):void 0},!1),this},c.prototype.log=function(a){return this.listen(function(b){console.log(a||b)})},c.prototype.filter=function(a){return Analyze("filter",a),b.call(this,function(b,c){return a.call(this,b)===!0?c.next(b):c.stop()})},c.prototype.map=function(a){var c,f=function(b,c){return c.next(a)};switch(typeof a){case"function":c=function(b,c){return c.next(a.call(this,b))};break;case"string":if(a.indexOf("/")>=0)return this.get(a);c="."==a[0]?function(b,c){var d=a.indexOf("()")>0?b[a.slice(1,-2)]:b[a.slice(1)],f=e.exist(d)?d:a,g=f;return e.fn(f)&&a.indexOf("()")>0&&(g=f()),c.next(g)}:"@"==a[0]?1==a.length?function(a,b){b.next(this)}:function(b,c){var d=a.indexOf("()")>0?this[a.slice(1,-2)]:this[a.slice(1)],f=e.exist(d)?d:a,g=f;return e.fn(f)&&a.indexOf("()")>0&&(g=f.call(this)),c.next(g)}:f;break;case"object":c=e.array(a)?function(b,c){var f=[];return d(a,function(a){var c;f.push(e.str(a)&&"."==a[0]&&e.exist(c=b[a.slice(1)])?c:a)}),c.next(f)}:function(b,c){var d,e,f={};for(var g in a)e=a[g],0==e.indexOf(".")&&b[e.slice(1)]&&(d=b[e.slice(1)]),0==e.indexOf("@")&&(this[e.slice(1)]||this[e.slice(1,-2)])&&(d=e.indexOf("()")>0?this[e.slice(1,-2)]():this[e.slice(1)]),f[g]=d;return c.next(f)};break;default:c=f}return b.call(this,c)},c.prototype.nth=function(a){return Analyze("nth",a),b.call(this,function(b,c){return c.next(b[a+1])})},c.prototype.get=function(a){return Analyze("get",a),b.call(this,function(b,c){return c.next(Utils.getObject(b,a))})},c.prototype.reduce=function(a,c){return Analyze("reduce",1==arguments.length?c=a:c),b.call(this,function(b,d){var f=d.bus();return d.next(0!=f.data.takes.length||e.exist(a)?c.call(this,f.data.takes.last()||a,b):b)})},c.prototype.take=function(a){return Analyze("take",a),b.call(this,function(b,c){var d=c.bus();return d.data.limit=d.data.limit||a,d.data.takes.length===d.data.limit?c.stop():c.next(b)})},c.prototype.skip=function(a){return Analyze("skip",a),b.call(this,function(b,c){return c.bus().data.fires.length>a?c.next(b):c.stop()})},c.prototype.interpolate=function(a){return Analyze("interpolate",a),b.call(this,function(b,c){return c.next(Utils.interpolate(a,b))})},c.prototype.mask=function(a){return Analyze("mask",a),b.call(this,function(b,c){return c.next(e.str(b)?Utils.interpolate(b,a):b)})},c.prototype.unique=function(a){return Analyze("unique",a),a=a||Warden.configure.cmp,b.call(this,function(b,c){var d=c.bus().data,e=d.fires,f=d.takes,g=(e.length>1||f.length>0)&&(a(b,e[e.length-2])||a(b,f.last()));return g?c.stop():c.next(b)})},c.prototype.debounce=function(a){return Analyze("debounce",a),b.call(this,function(b,c){var d=c.bus();clearTimeout(d.data.dbtimer),d.data.dbtimer=setTimeout(function(){delete d.data.dbtimer,c.play(),c.next(b)},a),c.pause()})},c.prototype.getCollected=function(a){return Analyze("getCollected",a),b.call(this,function(b,c){{var d=c.bus();d.data.fires.length-1}d.data.tmpCollection=d.data.tmpCollection||[],d.data.tmpCollection.push(b),d.data.timer?c.pause():(d.data.timer=setTimeout(function(){var a=d.data.tmpCollection;clearTimeout(d.data.timer),delete d.data.timer,delete d.data.tmpCollection,c.play(),c.next(a)},a),c.pause())})},c.prototype.filterFor=function(a){var c=null;return b.call(this,function(b,d){var e={get:function(a){return a?a(c):c},next:function(a){c=a,d.next(a)},stop:function(){d.stop()}};return a(b,e)})},c.prototype.collectFor=function(a){var b=[];return this.listen(function(a){b.push(a)}),Warden.makeStream(function(c){a.listen(function(){c(b),b=[]})}).bus()},c.prototype.equals=function(a,b){return b=b||Warden.configure.cmp,this.filter(function(c){return b(a,c)})},c.prototype.delay=function(a){return Analyze("delay",a),b.call(this,function(b,c){setTimeout(function(){c.next(b)},a)})},c.prototype.toggle=function(a,b){var c=!1;return this.listen(function(d){c?a.call(this,d):b.call(this,d),c=!c})},c.prototype.after=function(a,c){var d=!1;return a.listen(function(){d=!0}),b.call(this,function(a,b){d?(d=c===!0?!1:!0,b.play(),b.next(a)):b.pause()})},c.prototype.repeat=function(b,c){var d=this,e=b,f=Warden.makeStream(function(a){d.listen(function(d){var f=setInterval(function(){b?(a(d),b--):(b=e,clearInterval(f))},c)})}).bus();return a(f,this)},c.prototype.waitFor=function(a){var b=this;return Warden.makeStream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).bus()},c.prototype.merge=function(){function a(a,b,c){return Warden.makeStream(function(c){a.listen(c),b.listen(c)},c).bus()}var b=Utils.toArray(arguments);return b.unshift(this),Utils.reduce(b,function(b,c){return a(b,c,b.host.$$context)})},c.prototype.resolveWith=function(a,b){var c=this,d=this.host.$$context;return Warden.makeStream(function(e){c.sync(a).listen(function(a){e(b.call(d,a[0],a[1]))})},d).bus()},c.prototype.combine=function(a,b,c){var d=this,e=this.host.$$context;return Warden.makeStream(function(f){function g(a,c){f(b.call(e,a,c))}d.listen(function(b){g(b,a.data.last||c)}),a.listen(function(a){g(d.data.last||c,a)})},e).bus()},c.prototype.sync=function(){var b,c=Utils.toArray(arguments),e=[],f=[];return c.unshift(this),e.length=f.length=c.length,b=Warden.makeStream(function(a){d(c,function(b,d){b.listen(function(b){var g=f.length?!0:!1;Utils.forWhile(f,function(a,b){return b==d?!0:(a||(g=!1),a)},!1),e[d]=b,g?(a(e),e=[],f=[],e.length=f.length=c.length):f[d]=!0})})}).bus(),a(b,this)},c.prototype.syncFlat=function(){var b=this,c=Utils.toArray(arguments),d=Warden.makeStream(function(a){b.sync.apply(b,c).listen(function(b){a.call(this,Utils.flatten(b))})}).bus();return a(d,this)},c.prototype.lock=function(){this.host.pop(this)},c.prototype.lockChildren=function(){this.host.popAllDown(this)},c.prototype.lockParents=function(){this.host.popAllUp(this)},c.prototype.unlock=function(){this.host.push(this)},c.prototype.unlockChildren=function(){this.host.pushAllDown(this)},c.prototype.unlockParents=function(){function a(b){e.exist(b.parent)&&(b.host.push(b.parent),a(b.parent))}this.host.push(this),a(this)},Warden.configure.addToDatabus=function(a,d,e,f){d=d||a.name,c.prototype[d]=function(){return Analyze(d,arguments[f||0]),b.call(this,a(arguments))}},c}();Warden.watcher=function(){var is=Utils.is,each=Utils.each;return function(){var argv=Utils.toArray(arguments).slice(1,arguments.length),argc=argv.length,bus=arguments[0],a=argv[0],b=argv[1],fn,st;if(1===argc)is.str(a)?fn=function(b){this[a]=b}:is.fn(a)&&(fn=function(b){a(b)});else if(is.obj(a)&&is.str(b))if(b.indexOf("/")>=0){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:fn=function(c){a[b]=c};else is.fn(b)&&(fn=function(c){b.call(a,c)});return st=fn,{update:fn,unbind:function(){st=fn,fn=function(){}},bind:function(){fn=st}}}}(),jQueryInited&&Warden.extend(jQuery)});