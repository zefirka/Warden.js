!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(Warden){"use strict";function Processor(a,b){var c=a||[],d=0,e=0,f={$continue:function(a){return g.tick(a)},$break:function(){return g.tick({},1)},$lock:function(){return d=1},$unlock:function(){return d=0},$update:function(){b.update()},$host:function(){return b}},g={process:function(a){return Utils.is.exist(a)?c.push(a):c},start:function(a,b,f){return g.ctx=b,g.fin=f,e=d?0:e,e==c.length?(e=0,f(a)):void this.tick(a)},tick:function(a,b){return b?e=0:e==c.length?(e=0,g.fin(a)):(e++,void c[e-1].apply(g.ctx,[a,f]))}};return g}Warden.version="0.1.0",Warden.configure={};var Utils,Analyze;!function(){var a="function",b="number",c="string",d="object",e="boolean";Utils=function(){var f=function(a){var b=[a],c=!1,d=function(a){var d=j(b,function(b){return b(a)});return c?d.every(k):d.some(k)};return d.or=function(a){return b.push(a),d},d.and=function(a){return c=!0,d.or(a)},d.butNot=function(a){return d.and(m(a))},d},g=function(a,b){return a.prototype[b]?function(c,d){a.prototype[b].call(c,d)}:!1},h=g(Array,"forEach")||function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)},i=g(Array,"filter")||function(a,b){var c=[];return h(a,function(a,d){b(a,d)===!0&&c.push(a)}),filterd},j=g(Array,"map")||function(a,b){var c=[];return h(a,function(a,d){c[d]=b(a,d)}),c},k=function(a){return a?!0:!1},l=function(a){return function(b){return typeof b===a}},m=function(a){return function(b){return!a(b)}},n={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:l(a),num:l(b),str:l(c),bool:l(e),truthy:k,falsee:m(k),equals:function(a){return function(b){return a===b}}};return n.obj=function(a){return l(d)(a)&&!n.array(a)},n.not=function(){var a={};for(var b in n)a[b]=m(n[b]);return a}(),{is:n,$let:f,forEach:h,each:h,filter:i,map:j,extend:function(){function a(b,c){var d,e,f,g,h;for(var i in c)if(c[i]&&n.obj(c[i]))b[i]=b[i]||{},a(b[i],c[i]);else if(n.array(c[i]))if(b[i]=b[i]||[],n.obj(b[i][0])&&n.obj(c[i][0]))for(h=c[i],d=f=0,g=h.length;g>f;d=++f)e=h[d],b[i][d]=a(b[i][d]||{},c[i][d]);else b[i]=c[i];else b[i]=c[i];return b}var b=Array.prototype.slice.call(arguments);return b.reduce(function(b,c){return a(b,c)})},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:function(){var a={};return{get:function(b){return a[b]},set:function(b){var c=parseInt(a[b],16)||0;return a[b]=(c+1).toString(16)}}}()}}(),Analyze=function(a,b){{var c=Analyze.MAP[a],d=typeof b;c[c.length-1]}if(c&&-1==c.indexOf(d))throw"TypeError: unexpected type of argument at: ."+a+"(). Expected type: "+c.join(" or ")+". Your argument is type of: "+d},Analyze.MAP={extend:[d,a],reduce:[a],take:[a,b],filter:[a],skip:[b],setup:[a],makeStream:[c,a,d],debounce:[b],getCollected:[b],interpolate:[c],mask:[d],lock:[c]}}(),Warden.Utils=Utils,Warden.configure.exceptionManager=Analyze,Warden.configure.datatypes=function(a,b){if(Analyze.MAP[a])throw"This name is already exist";Analyze.MAP[a]=b},Warden.extend=function(){var a=Utils.each,b=Utils.is,c=Utils.extend,d="addEventListener",e="attachEvent",f={names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},max:512,emitter:null,listener:null};return Warden.configure.changeDefault=function(a){return Utils.extend(f,a)},Warden.configure.natives=function(a){d=a.listener,e=a.altenativeListener},function(g,h){Analyze("extend",g);var i=c({},f,h||{}),j=g,k=!0,l=i.names;b.fn(g)?j=g.prototype:k=!1;var m=j[l.emit]||j[l.listen]||j[l.unlisten]||j[l.stream];if(b.exist(m))throw new Error("Can't overwrite: "+(m.name?m.name:m)+" of object");return"undefined"!=typeof jQuery?(i.emitter=i.emitter||"trigger",i.listener=i.listener||"on"):(b.fn(j[d])||b.fn(j[e]))&&(i.listener=i.listener||(b.fn(j[d])?d:e)),j[l.emit]=function(b){var c=this,d=this.$$handlers.filter(function(a){return a.type==b||a.type==b.type});return a(d,function(a){a.callback.call(c,b)}),this},j[l.listen]=function(a,b){var c=this,d=this.$$handlers=this.$$handlers||[];if(!(this.$$handlers.length<i.max))throw new Error("Maximal handlers limit reached");return!d.filter(function(b){return b.type==a}).length&&this[i.listener]&&this[i.listener].apply(this,[a,function(a){c.emit(a)}]),this.$$handlers.push({type:a,callback:b}),this},j[l.unlisten]=function(b,c){var d=this;if(d.$$handlers){var e=[];a(d.$$handlers,function(a,b){a.callback.name==(c.name||c)&&e.push(b)}),a(e,function(a){d.$$handlers.splice(a,1)})}return this},j[l.stream]=function(a,b){var c=Warden.makeStream(a,b||this),d=this.$$handlers=this.$$handlers||[];return!d.filter(function(b){return b.type==a}).length&&this[i.listener]&&this[i.listener].apply(this,[a,function(a){c.eval(a)}]),this.$$handlers.push({type:a,callback:function(a){c.eval(a)}}),c.get()},g}}(),Warden.makeStream=function(){function a(a){var d=[];return{$$id:Utils.$hash.set("s"),$$context:a,eval:function(c){b(d,function(b){b.fire(c,a)})},push:function(a){return d.push(a),a},pushAllUp:function(a){function b(a){c.exist(a.parent)&&(d.push(a.parent),b(a.parent))}d.push(a),b(a)},pushAllDown:function(a){var c=this;b(c.push(a).children,function(a){c.pushAllDown(a)})},pop:function(a){return b(d,function(b,c){a.$$id==b.$$id&&(d=d.slice(0,c).concat(d.slice(c+1,d.length)))}),a},popAllDown:function(a){var c=this;b(c.pop(a).children,function(a){c.popAllDown(a)})},popAllUp:function(a){var b=this.pop(a);c.exist(b.parent)&&this.popAllUp(b.parent)},get:function(){var a=new DataBus;return a.host(this),a}}}var b=Utils.each,c=Utils.is;return function(d,e,f){var g,h,i,j=[];if(Analyze("makeStream",d),e=e||{},g=a(e),c.fn(d)){if(f===!0){h=d.toString();for(i in e)e.hasOwnProperty(i)&&j.push(i);b(j,function(a){h.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",e)})}d.call(e,function(a){g.eval(a)})}else c.array(d)&&b(function(){var a=[];return b(["pop","push","slice","splice","reverse","map","forEach","reduce","join","filter","concat","shift","unshift"],function(b){a.push({name:b,fun:Array.prototype[b]})}),a}(),function(a){d[a.name]=function(){a.fun.apply(d,arguments),g.eval({type:arguments.callee.name,data:arguments})}});return g}}();var DataBus=function(){function a(a,b){a.parent=b,b.children.push(a)}function b(b){var e,g,h=f(this.$$id,"processor");return b?(e=[],d(h.process(),function(a){e.push(a)}),e.push(b),g=new c(e),g.host(this.host()),a(g,this),g):h}function c(a){var b=this,c=null;this.$$id=Utils.$hash.set("d");f(this.$$id,{processor:new Processor(a||[],b),host:0,binding:null,handlers:[],setup:function(a){return a}});this.parent=null,this.children=[],this._={fires:new Utils.Queue,takes:new Utils.Queue},this.bindTo=function(a,b,d){var e=this;return c||(c=Warden.watcher(e,a,b,d)),c},this.update=function(a){c&&c.update(a||this._.takes[this._.takes.length-1])}}var d=Utils.each,e=Utils.is,f=function(){var a={};return function(b,c,d){return e.exist(d)?(a[b][c]=e.fn(d)?d(a[b][c]):d,a[b][c]):a[b]&&e.exist(a[b][c])?a[b][c]:(a[b]=c,a[b])}}();return c.prototype.fire=function(a,b){var c=this.$$id,g=this,h=f(c,"handlers"),i=f(c,"processor");a=f(c,"setup")(e.exist(a)?a:{}),this._.fires.push(a),i.start(a,b,function(a){g._.takes.push(a),g.update(a),d(h,function(c){c.apply(b,[a])})})},c.prototype.setup=function(a){Analyze("setup",a),f(this.$$id,"setup",function(){return a})},c.prototype.host=function(a){return a?f(this.$$id,"host",a):f(this.$$id,"host")},c.prototype.listen=function(a){var b=this;return f(this.$$id,"handlers",function(c){return c.push(e.fn(a)?a:function(){console.log(a)}),c.length<=1&&b.host().push(b),c}),this},c.prototype.mute=function(a){return a=e.fn(fn)?a.name:a,d(f(this.$$id,"handlers"),function(b,c){b.name==a&&f(this.$$id,"handlers",function(a){return a.slice(0,c).concat(a.slice(c+1,a.length))})}),this},c.prototype.log=function(){return this.listen(function(a){return console.log(a)})},c.prototype.filter=function(a){return Analyze("filter",a),b.call(this,function(b,c){return a.apply(this,[b])===!0?c.$continue(b):c.$break()})},c.prototype.map=function(a){var c,f=typeof a;switch(f){case"function":c=function(b,c){return c.$continue(a.call(this,b))};break;case"string":c=function(b,c){var d=b[a],f=e.exist(d)?d:a;return c.$continue(f)};break;case"object":c=e.array(a)?function(b,c){var f=[];return d(a,function(a){var c=b[a];f.push(e.exist(c)?c:a)}),c.$continue(f)}:function(b,c){var d,f={};for(var g in a)d=b[a[g]],f[g]=e.exist(d)?d:a[g];return c.$continue(f)};break;default:c=function(b,c){return c.$continue(a)}}return b.call(this,c)},c.prototype.reduce=function(a,c){return Analyze("reduce",c,arguments.length),b.call(this,function(b,d){var e=d.$host(),f=a,g=b;return(e._.takes.length>=1||"first"==a||"-f"==a)&&(f=e._.takes[e._.takes.length-1]),d.$continue(c.call(this,f,g))})},c.prototype.take=function(a){return Analyze("take",a),e.fn(a)?this.filter(a):b.call(this,function(b,c){var d=c.$host();return d._.limit=d._.limit||a,d._.takes.length===d._.limit?c.$break():c.$continue(b)})},c.prototype.skip=function(a){return Analyze("skip",a),b.call(this,function(b,c){var d=c.$host();return d._.fires.length<=a?void c.$break():c.$continue(b)})},c.prototype.interpolate=function(a,c){return Analyze("interpolate",a),b.call(this,function(b,d){var e=c||/{{\s*[\w\.]+\s*}}/g;return d.$continue(a.replace(e,function(a){return b[a.slice(2,-2)]}))})},c.prototype.mask=function(a,c){return Analyze("mask",a),b.call(this,function(b,d){var e=c||/{{\s*[\w\.]+\s*}}/g;return d.$continue(b.replace(e,function(b){return a[b.slice(2,-2)]}))})},c.prototype.unique=function(a){return a=e.fn(a)?a:function(a,b){return a===b},b.call(this,function(b,c){var d=c.$host()._.fires,e=c.$host()._.takes;return(d.length>1||e.length>0)&&(a(b,d[d.length-2])||a(b,e[e.length-1]))?c.$break():c.$continue(b)})},c.prototype.debounce=function(a){return Analyze("debounce",a),b.call(this,function(b,c){var d=c.$host();clearTimeout(d._.dbtimer),d._.dbtimer=setTimeout(function(){delete d._.dbtimer,c.$unlock(),c.$continue(b)},a),c.$lock()})},c.prototype.getCollected=function(a){return Analyze("getCollected",a),b.call(this,function(b,c){{var d=c.$host();d._.fires.length-1}d._.tmpCollection=d._.tmpCollection||[],d._.tmpCollection.push(b),d._.timer?c.$lock():(d._.timer=setTimeout(function(){var a=d._.tmpCollection;clearTimeout(d._.timer),delete d._.timer,delete d._.tmpCollection,c.$unlock(),c.$continue(a)},a),c.$lock())})},c.prototype.after=function(a,c){var d=!1;return a.listen(function(){d=!0}),b.call(this,function(a,b){d?(d=c===!0?!1:!0,b.$unlock(),b.$continue(a)):b.$lock()})},c.prototype.waitFor=function(a){var b=this;return Warden.makeStream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).get()},c.prototype.merge=function(a){var b=this,c=Warden.makeStream(function(c){a.listen(c),b.listen(c)}).get();return c},c.prototype.resolveWith=function(a,b){var c=this,d=this.host().$$context;return Warden.makeStream(function(e){c.sync(a).listen(function(a){var c=a[0],f=a[1];e(b.call(d,c,f))})},d).get()},c.prototype.combine=function(a,b,c){var d,e,f=this,c=c||this.host().$$context;return a.listen(function(a){e=a}),this.listen(function(a){d=a}),Warden.makeStream(function(g){function h(){g(b.call(c,d,e))}f.listen(h),a.listen(h)},c).get()},c.prototype.sync=function(b){var c=this,b=Warden.makeStream(function(a){var d,e,f=!1,g=!1,h=function(){d=null,e=null,f=!1,g=!1};b.listen(function(b){f?(a([d,b]),h()):(e=b,g=!0)}),c.listen(function(b){g?(a([b,e]),h()):(d=b,f=!0)})}).get();return a(b,this),b},c.prototype.lock=function(a){if(e.exist(a))switch(Analyze("lock",a),a){case"-c":this.lockChildren();break;case"-P":this.lockParents();break;case"-p":this.host().pop(this.parent)}else this.host().pop(this)},c.prototype.lockChildren=function(){this.host().popAllDown(this)},c.prototype.lockParents=function(){this.host().popAllUp(this)},c.prototype.unlock=function(){this.host().push(this)},c.prototype.unlockChildren=function(){this.host().pushAllDown(this)},c.prototype.unlockParents=function(){function a(b){e.exist(b.parent)&&(b.host().push(b.parent),a(b.parent))}this.host().push(this),a(this)},Warden.configure.addToDatabus=function(a,d,e,f){d=d||a.name,c.prototype[d]=function(){if(Analyze(d,arguments[f||0]),e&&e!=arguments.length)throw"Unexpected arguments count";return b.call(this,a(arguments))}},c}();Warden.watcher=function(){return function(bus,a,b,c){var fn,is=Utils.is,each=Utils.each;if(!is.exist(b)&&is.exist(a))is.str(a)?fn=function(b){return this[a]=b}:is.obj(a)?fn=function(b){a=b}:is.fn(a)&&(fn=function(b){return a(b)});else if(is.exist(b))if(is.obj(a)&&is.str(b))if(b.split("/").length>1){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:function(c){return a[b]=c};else is.obj(a)&&is.fn(b)&&(fn=function(c){return b.call(a,c)});return bus.listen(fn),Utils.extend(new function(){},{update:fn,unbind:function(a){bus.mute(a)},bind:function(){bus.listen(fn||fn)}})}}()});