!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(Warden){"use strict";function Processor(a,b){var c=a||[],d=0,e=0,f={$continue:function(a){return g.tick(a)},$break:function(){return g.tick({},1)},$lock:function(){return d=1},$unlock:function(){return d=0},$update:function(){b.update()},$host:function(){return b}},g={process:function(a){return Utils.is.exist(a)?c.push(a):c},start:function(a,b,f){return g.ctx=b,g.fin=f,e=d?0:e,e==c.length?(e=0,f(a)):void this.tick(a)},tick:function(a,b){return b?e=0:e==c.length?(e=0,g.fin(a)):(e++,void c[e-1].apply(g.ctx,[a,f]))}};return g}var jQueryInited="undefined"!=typeof jQuery;Warden.version="0.1.1",Warden.configure={};var Utils,Analyze,UserMap={};!function(){function a(a){return function(b,c){var d=a[b],e=Utils.is.exist(d)?Utils.some(d,function(a){return typeof c===a}):!0;if(!e)throw"TypeError: unexpected type of argument at: ."+b+"(). Expected type: "+d.join(" or ")+". Your argument is type of: "+typeof c}}var b="function",c="number",d="string",e="object",f="array",g="boolean",h="undefined";Utils=function(){var a=function(a){var b=[a],c=!1,d=function(a){var d=k(b,function(b){return b(a)});return c?m(d,n):l(d,n)};return d.or=function(a){return b.push(a),d},d.and=function(a){return c=!0,d.or(a)},d.butNot=function(a){return d.and(p(a))},d},f=function(a,b){return Array.prototype[a]?function(b,c){return Array.prototype[a].call(b,c)}:b},h=f("forEach",function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}),i=function(a,b,c,d){c=c||!1,d=void 0!==d?d:!0;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return d},j=f("filter",function(a,b){var c=[];return h(a,function(a,d){b(a,d)===!0&&c.push(a)}),filterd}),k=f("map",function(a,b){var c=[];return h(a,function(a,d){c[d]=b(a,d)}),c}),l=f("some",function(a,b){return i(a,b,!0,!1)}),m=f("every",function(a,b){return i(a,b)}),n=function(a){return a?!0:!1},o=function(a){return function(b){return typeof b===a}},p=function(a){return function(b){return!a(b)}},q=function(a,b,c,d){var e=a.name||d||"function",f=[e,"have been ran",b,"times:"].join(" ");console.time(f);for(var g=0;b>g;g++)a(c?c(b):b);console.timeEnd(f)},r={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:o(b),num:o(c),str:o(d),bool:o(g),truthy:n,falsee:p(n),equals:function(a){return function(b){return a===b}}};return r.obj=function(a){return o(e)(a)&&!r.array(a)},r.not=function(){var a={};for(var b in r)a[b]=p(r[b]);return a}(),{is:r,not:p,$let:a,forEach:h,forWhile:i,each:h,filter:j,some:l,every:m,map:k,profile:q,log:function(a){var b={},c=arguments.length,d=Array.prototype.slice.call(arguments),e=/{{\s*[\w\.]+\s*}}/g;2==c&&Utils.is.obj(d[1])?b=d[1]:d.slice(1,c).forEach(function(a,c){b[c]=a}),console.log(a.replace(e,function(a){var c=b[a.slice(2,-2)];return Utils.is.obj(c)&&(c=JSON.stringify(c)),c}))},flatten:function(a){var b=[];return h(a,function(c){r.array(c)?a.push.apply(flatten(c)):b.push(c)}),b},extend:function(){function a(b,c){var d,e,f,g;for(var h in c)if(c[h]&&r.obj(c[h]))b[h]=b[h]||{},a(b[h],c[h]);else if(r.array(c[h]))if(b[h]=b[h]||[],r.obj(b[h][0])&&r.obj(c[h][0]))for(g=c[h],d=e=0,f=g.length;f>e;d=++e)b[h][d]=a(b[h][d]||{},c[h][d]);else b[h]=c[h];else b[h]=c[h];return b}var b=Array.prototype.slice.call(arguments);return b.reduce(function(b,c){return a(b,c)})},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:function(){var a={};return{get:function(b){return a[b]},set:function(b){var c=parseInt(a[b],16)||0;return a[b]=(c+1).toString(16)}}}()}}(),Analyze=a({extend:[e,b,f],reduce:[b],take:[b,c],filter:[b],skip:[c],setup:[b],makeStream:[d,b,d],debounce:[c],getCollected:[c],interpolate:[d],mask:[d],unique:[b,h],lock:[d],nth:[e],get:[d]}),Warden.configure.exceptionMap={},Warden.configure.exceptionManager=a(Warden.configure.exceptionMap)}(),Warden.Utils=Utils,Warden.configure.datatypes=function(a,b){if(Analyze.MAP[a])throw"This name is already exist";Analyze.MAP[a]=b},Warden.extend=function(){var a=Utils.each,b=Utils.is,c=Utils.map,d=Utils.filter,e=Utils.extend,f="addEventListener",g="attachEvent",h={arrayMethods:["pop","push","slice","splice","reverse","join","concat","shift","sort","unshift"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null};return Warden.configure.changeDefault=function(a){return Utils.extend(h,a)},Warden.configure.natives=function(a){f=a.listener,g=a.altenativeListener},function(i,j){Analyze("extend",i);var k=e({},h,j||{}),l=i,m=!0,n=k.names;if(b.fn(i))l=i.prototype;else if(m=!1,b.array(i)){var o=c(k.arrayMethods,function(a){return{name:a,fun:Array.prototype[a]}});a(o,function(a){i[a.name]=function(){var b=Array.prototype.slice.call(arguments);a.fun.apply(i,b),i.emit({type:a.name,current:i,data:b})}})}var p=l[n.emit]||l[n.listen]||l[n.unlisten]||l[n.stream];if(b.exist(p))throw new Error("Can't overwrite: "+(p.name?p.name:p)+" of object");return jQueryInited&&(m?!0:i instanceof jQuery)?(k.emitter=k.emitter||"trigger",k.listener=k.listener||"on"):(b.fn(l[f])||b.fn(l[g]))&&(k.listener=k.listener||(b.fn(l[f])?f:g)),l[n.emit]=function(c,e){var f=this,g=b.str(c)?c:c.type,e=b.obj(c)?c:e||c,h=d(this.$$handlers,function(a){return a.type==g});return a(h,function(a){a.callback.call(f,e)}),this},l[n.listen]=function(a,b){var c=this,e=this.$$handlers=this.$$handlers||[];return!d(e,function(b){return b.type==a}).length&&this[k.listener]&&this[k.listener].apply(this,[a,function(a){c.emit(a)}]),this.$$handlers.push({type:a,callback:b}),this},l[n.unlisten]=function(b,c){var d=this;if(d.$$handlers){var e=[];a(d.$$handlers,function(a,b){a.callback.name==(c.name||c)&&e.push(b)}),a(e,function(a){d.$$handlers.splice(a,1)})}return this},l[n.stream]=function(a,b){var c=Warden.makeStream(a,b||this),e=this.$$handlers=this.$$handlers||[];return!d(e,function(b){return b.type==a}).length&&this[k.listener]&&this[k.listener].apply(this,[a,function(a){c.eval(a)}]),this.$$handlers.push({type:a,callback:function(a){c.eval(a)}}),c.get()},i}}(),Warden.makeStream=function(){function a(a){var d=[];return{$$id:Utils.$hash.set("s"),$$context:a,eval:function(c){b(d,function(b){b.fire(c,a)})},transform:function(a){c.fn(a)&&(d=Utils.map(d,function(b){a(b)}))},push:function(a){return d.push(a),a},pushAllUp:function(a){function b(a){c.exist(a.parent)&&(d.push(a.parent),b(a.parent))}d.push(a),b(a)},pushAllDown:function(a){var c=this;b(c.push(a).children,function(a){c.pushAllDown(a)})},pop:function(a){return b(d,function(b,c){a.$$id==b.$$id&&(d=d.slice(0,c).concat(d.slice(c+1,d.length)))}),a},popAllDown:function(a){var c=this;b(c.pop(a).children,function(a){c.popAllDown(a)})},popAllUp:function(a){var b=this.pop(a);c.exist(b.parent)&&this.popAllUp(b.parent)},get:function(){var a=new DataBus;return a.host(this),a},bus:function(){return this.get()}}}var b=Utils.each,c=Utils.is;return function(d,e,f){var g,h,i,j=[];if(Analyze("makeStream",d),e=e||{},g=a(e),c.fn(d)){if(f===!0){h=d.toString();for(i in e)e.hasOwnProperty(i)&&j.push(i);b(j,function(a){h.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",e)})}d.call(e,function(a){g.eval(a)})}return g}}();var DataBus=function(){function a(a,b){a.parent=b,b.children.push(a)}function b(b){var e,g,h=f(this.$$id,"processor");return b?(e=[],d(h.process(),function(a){e.push(a)}),e.push(b),g=new c(e),g.host(this.host()),a(g,this),g):h}function c(a){var b=this,c=[];this.$$id=Utils.$hash.set("d"),f(this.$$id,{processor:new Processor(a||[],b),host:0,handlers:[],setup:function(a){return a}}),this.parent=null,this.children=[],this._={fires:new Utils.Queue,takes:new Utils.Queue,last:null},this.bindTo=function(a,b,d){var e=Warden.watcher(this,a,b,d);return c.push(e),e},this.update=function(a){c.length&&d(c,function(c){c.update(a||b._.takes.last())})}}var d=Utils.each,e=Utils.is,f=function(){var a={};return function(b,c,d){return e.exist(d)?(a[b][c]=e.fn(d)?d(a[b][c]):d,a[b][c]):a[b]&&e.exist(a[b][c])?a[b][c]:(a[b]=c,a[b])}}();return c.prototype.fire=function(a,b){var c=this.$$id,g=this,h=f(c,"handlers"),i=f(c,"processor");a=f(c,"setup")(e.exist(a)?a:{}),this._.fires.push(a),i.start(a,b,function(a){g._.takes.push(a),g._.last=a,g.update(a),d(h,function(c){c.apply(b,[a])})})},c.prototype.setup=function(a){Analyze("setup",a),f(this.$$id,"setup",function(){return a})},c.prototype.host=function(a){return a?f(this.$$id,"host",a):f(this.$$id,"host")},c.prototype.listen=function(a){var b=this;return f(this.$$id,"handlers",function(c){return c.push(e.fn(a)?a:function(){console.log(a)}),c.length<=1&&b.host().push(b),c}),this},c.prototype.mute=function(a){return a=e.fn(fn)?a.name:a,d(f(this.$$id,"handlers"),function(b,c){b.name==a&&f(this.$$id,"handlers",function(a){return a.slice(0,c).concat(a.slice(c+1,a.length))})}),this},c.prototype.log=function(){return this.listen(function(a){return console.log(a)})},c.prototype.filter=function(a){return Analyze("filter",a),b.call(this,function(b,c){return a.apply(this,[b])===!0?c.$continue(b):c.$break()})},c.prototype.map=function(a){var c;if(e.fn(a))c=function(b,c){return c.$continue(a.call(this,b))};else if(e.str(a)){if(a.indexOf("/")>=0)return this.get(a);c=function(b,c){var d=b[a],f=e.exist(d)?d:a;return c.$continue(f)}}else c=e.array(a)?function(b,c){var f=[];return d(a,function(a){var c=b[a];f.push(e.exist(c)?c:a)}),c.$continue(f)}:e.obj(a)?function(b,c){var d,f={};for(var g in a)d=b[a[g]],f[g]=e.exist(d)?d:a[g];return c.$continue(f)}:function(b,c){return c.$continue(a)};return b.call(this,c)},c.prototype.nth=function(a){Analyze("nth",a),b.call(this,function(b,c){return c.$continue(b[a])})},c.prototype.get=function(a){return Analyze("get",a),b.call(this,function(b,c){var f=b;return d(a.split("/"),function(a){var b,c=a.length-1;if("["==a[0]&&"]"==a[c]){if(b=a.slice(1,c),e.exist(b)){if(!e.num(parseInt(b)))throw"Wrong syntax at DataBus.get() method";a=parseInt(b)}}else if(!e.exist(f[a]))throw"Can't find "+a+" property";f=f[a]}),c.$continue(f)})},c.prototype.reduce=function(a,c){return 1==arguments.length&&(c=a,a=void 0),Analyze("reduce",c),b.call(this,function(b,d){var e=d.$host(),f=a,g=b;return e._.takes.length>0&&(f=e._.takes.last()),d.$continue(c.call(this,f,g))})},c.prototype.take=function(a){return Analyze("take",a),e.fn(a)?this.filter(a):b.call(this,function(b,c){var d=c.$host();return d._.limit=d._.limit||a,d._.takes.length===d._.limit?c.$break():c.$continue(b)})},c.prototype.include=function(){var a=arguments,c=a.length;return b.call(this,function(b,d){for(var f,g=d.$host(),h=0,i=c;i>h;h++)if(f=a[h],e.array(f))for(var j=0,k=f.length;k>j;j++)e.exist(g._[f[j]])&&(b[f[j]]=g._[f[j]]);else e.exist(g._[f])&&(b[f]=g._[f]);return d.$continue(b)})},c.prototype.skip=function(a){return Analyze("skip",a),b.call(this,function(b,c){var d=c.$host();return d._.fires.length<=a?void c.$break():c.$continue(b)})},c.prototype.interpolate=function(a,c){return Analyze("interpolate",a),b.call(this,function(b,d){var e=c||/{{\s*[\w\.]+\s*}}/g;return d.$continue(a.replace(e,function(a){return b[a.slice(2,-2)]}))})},c.prototype.mask=function(a,c){return Analyze("mask",a),b.call(this,function(b,d){var e=c||/{{\s*[\w\.]+\s*}}/g;return d.$continue(b.replace(e,function(b){return a[b.slice(2,-2)]}))})},c.prototype.unique=function(a){return Analyze("unique",a),a=e.fn(a)?a:function(a,b){return a===b},b.call(this,function(b,c){var d=c.$host()._.fires,e=c.$host()._.takes;return(d.length>1||e.length>0)&&(a(b,d[d.length-2])||a(b,e.last()))?c.$break():c.$continue(b)})},c.prototype.debounce=function(a){return Analyze("debounce",a),b.call(this,function(b,c){var d=c.$host();clearTimeout(d._.dbtimer),d._.dbtimer=setTimeout(function(){delete d._.dbtimer,c.$unlock(),c.$continue(b)},a),c.$lock()})},c.prototype.getCollected=function(a){return Analyze("getCollected",a),b.call(this,function(b,c){{var d=c.$host();d._.fires.length-1}d._.tmpCollection=d._.tmpCollection||[],d._.tmpCollection.push(b),d._.timer?c.$lock():(d._.timer=setTimeout(function(){var a=d._.tmpCollection;clearTimeout(d._.timer),delete d._.timer,delete d._.tmpCollection,c.$unlock(),c.$continue(a)},a),c.$lock())})},c.prototype.toggle=function(a,c){var d=this;return this._.toggle=!1,b.call(this,function(b,e){var f=d._.toggle?a:c;return d._.toggle=!d._.toggle,e.$continue(f.call(d,b))})},c.prototype.after=function(a,c){var d=!1;return a.listen(function(){d=!0}),b.call(this,function(a,b){d?(d=c===!0?!1:!0,b.$unlock(),b.$continue(a)):b.$lock()})},c.prototype.waitFor=function(a){var b=this;return Warden.makeStream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).get()},c.prototype.merge=function(a){var b=this,c=Warden.makeStream(function(c){a.listen(c),b.listen(c)}).get();return c},c.prototype.resolveWith=function(a,b){var c=this,d=this.host().$$context;return Warden.makeStream(function(e){c.sync(a).listen(function(a){var c=a[0],f=a[1];e(b.call(d,c,f))})},d).get()},c.prototype.combine=function(a,b,c){var d,e,f=this,c=c||this.host().$$context;return a.listen(function(a){e=a}),this.listen(function(a){d=a}),Warden.makeStream(function(g){function h(){g(b.call(c,d,e))}f.listen(h),a.listen(h)},c).get()},c.prototype.sync=function(b){var c=this,d=Warden.makeStream(function(a){var d,e,f=!1,g=!1,h=function(){d=null,e=null,f=!1,g=!1};b.listen(function(b){f?(a([d,b]),h()):(e=b,g=!0)}),c.listen(function(b){g?(a([b,e]),h()):(d=b,f=!0)})}).bus();return a(d,this),d},c.prototype.syncFlat=function(b){return self=this,nbus=Warden.makeStream(function(a){self.sync(b).listen(function(b){a(Utils.flatten(b))})}).bus(),a(nbus,this),nbus},c.prototype.lock=function(){this.host().pop(this)},c.prototype.lockChildren=function(){this.host().popAllDown(this)},c.prototype.lockParents=function(){this.host().popAllUp(this)},c.prototype.unlock=function(){this.host().push(this)},c.prototype.unlockChildren=function(){this.host().pushAllDown(this)},c.prototype.unlockParents=function(){function a(b){e.exist(b.parent)&&(b.host().push(b.parent),a(b.parent))}this.host().push(this),a(this)},Warden.configure.addToDatabus=function(a,d,e,f){d=d||a.name,c.prototype[d]=function(){return Analyze(d,arguments[f||0]),b.call(this,a(arguments))}},c}();Warden.watcher=function(){var is=Utils.is,each=Utils.each;return function(bus,a,b,c){var fn;if(!is.exist(b)&&is.exist(a))is.str(a)?fn=function(b){return this[a]=b}:is.obj(a)?fn=function(b){a=b}:is.fn(a)&&(fn=function(b){return a(b)});else if(is.exist(b))if(is.obj(a)&&is.str(b))if(b.split("/").length>1){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:function(c){return a[b]=c};else is.obj(a)&&is.fn(b)&&(fn=function(c){return b.call(a,c)});return bus.listen(fn),Utils.extend(new function(){},{update:fn,unbind:function(a){bus.mute(a)},bind:function(){bus.listen(fn||fn)}})}}(),jQueryInited&&Warden.extend(jQuery)});