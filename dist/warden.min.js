!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(Warden){"use strict";function Processor(a,b){var c=a||[],d=0,e=0,f={$continue:function(a){return g.tick(a)},$break:function(){return g.tick({},1)},$lock:function(){return d=1},$unlock:function(){return d=0},$update:function(){b.update()},$host:function(){return b}},g={process:function(a){return Utils.is.exist(a)?c.push(a):c},start:function(a,b,f){return g.ctx=b,g.fin=f,e=d?0:e,e==c.length?(e=0,f(a)):void this.tick(a)},tick:function(a,b){return b?e=0:e==c.length?(e=0,g.fin(a)):(e++,void c[e-1].apply(g.ctx,[a,f]))}};return g}var jQueryInited="undefined"!=typeof jQuery;Warden.version="0.1.2",Warden.configure={};var Utils,Analyze,UserMap={};!function(){function a(a){return function(b,c){var d=a[b],e=Utils.is.exist(d)?Utils.some(d,function(a){return typeof c===a}):!0;if(!e)throw"TypeError: unexpected type of argument at: ."+b+"(). Expected type: "+d.join(" or ")+". Your argument is type of: "+typeof c}}var b="function",c="number",d="string",e="object",f="array",g="boolean",h="undefined";Utils=function(){var a=function(a){var b=[a],c=!1,d=function(a){var d=k(b,function(b){return b(a)});return c?m(d,n):l(d,n)};return d.or=function(a){return b.push(a),d},d.and=function(a){return c=!0,d.or(a)},d.butNot=function(a){return d.and(p(a))},d},f=function(a,b){return Array.prototype[a]?function(b,c){return Array.prototype[a].call(b,c)}:b},h=f("forEach",function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}),i=function(a,b,c,d){c=c||!1,d=void 0!==d?d:!0;for(var e=0,f=a.length;f>e;e++)if(b(a[e],e)===c)return c;return d},j=f("filter",function(a,b){var c=[];return h(a,function(a,d){b(a,d)===!0&&c.push(a)}),filterd}),k=f("map",function(a,b){var c=[];return h(a,function(a,d){c[d]=b(a,d)}),c}),l=f("some",function(a,b){return i(a,b,!0,!1)}),m=f("every",function(a,b){return i(a,b)}),n=function(a){return a?!0:!1},o=function(a){return function(b){return typeof b===a}},p=function(a){return function(b){return!a(b)}},q=function(a,b,c,d){var e=a.name||d||"function",f=[e,"have been ran",b,"times:"].join(" ");console.time(f);for(var g=0;b>g;g++)a(c?c(b):b);console.timeEnd(f)},r=function(a){return t.obj(a)&&t.not.exist(a.length)&&(a.length=Object.keys(a).length),Array.prototype.slice.call(a)},s=function(a){var b={},c=arguments.length,d=r(arguments),e=/{{\s*[\w\.]+\s*}}/g;return 2==c&&t.obj(d[1])?b=d[1]:h(d.slice(1,c),function(a,c){b[c]=a}),a.replace(e,function(a){var c=b[a.slice(2,-2)]||a;return t.obj(c)&&(c=JSON.stringify(c)),c})},t={exist:function(a){return"undefined"!=typeof a&&null!==a},array:function(a){return Array.isArray(a)},fn:o(b),num:o(c),str:o(d),bool:o(g),truthy:n,falsee:p(n),equals:function(a){return function(b){return a===b}}};return t.obj=function(a){return o(e)(a)&&!t.array(a)},t.not=function(){var a={};for(var b in t)a[b]=p(t[b]);return a}(),{is:t,not:p,$let:a,forEach:h,forWhile:i,each:h,filter:j,some:l,every:m,map:k,toArray:r,profile:q,interpolate:s,log:function(){console.log(s.apply(this,arguments))},flatten:function(a){var b=[];return h(a,function(c){t.array(c)?a.push.apply(flatten(c)):b.push(c)}),b},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},extend:function(){function a(b,c){var d,e,f,g;for(var h in c)if(c[h]&&t.obj(c[h]))b[h]=b[h]||{},a(b[h],c[h]);else if(t.array(c[h]))if(b[h]=b[h]||[],t.obj(b[h][0])&&t.obj(c[h][0]))for(g=c[h],d=e=0,f=g.length;f>e;d=++e)b[h][d]=a(b[h][d]||{},c[h][d]);else b[h]=c[h];else b[h]=c[h];return b}var b=r(arguments);return b.reduce(function(b,c){return a(b,c)})},Queue:function(a,b){var c=b||[],a=a||16,d=c.push;return c.last=function(){return c[c.length-1]},c.push=function(b){return this.length>=a&&this.shift(),d.apply(c,[b])},c},$hash:function(){var a={};return{get:function(b){return a[b]},set:function(b){var c=parseInt(a[b],16)||0;return a[b]=(c+1).toString(16)}}}()}}(),Analyze=a({extend:[e,b,f],listen:[d],stream:[d],unlisten:[d],reduce:[b],take:[b,c],filter:[b],skip:[c],setup:[b],makeStream:[h,d,b,f],debounce:[c],getCollected:[c],interpolate:[d],mask:[d],unique:[b,h],lock:[d],nth:[e],get:[d]}),Warden.configure.exceptionMap={},Warden.configure.exceptionManager=a(Warden.configure.exceptionMap)}(),Warden.Utils=Utils,Warden.configure.datatypes=function(a,b){if(Analyze.MAP[a])throw"This name is already exist";Analyze.MAP[a]=b},Warden.extend=function(){var a=Utils.each,b=Utils.is,c=Utils.map,d=Utils.filter,e=Utils.extend,f="addEventListener",g="attachEvent",h={arrayMethods:["pop","push","slice","splice","reverse","join","concat","shift","sort","unshift"],names:{emit:"emit",listen:"listen",stream:"stream",unlisten:"unlisten"},emitter:null,listener:null},i={},j=function(b){return i[b]=i[b]||[],a(Utils.toArray(arguments).slice(1),function(a){i[b].push(a)}),i[b]},k=function(a){return i[a]||[]};return Warden.configure.changeDefault=function(a){return Utils.extend(h,a)},Warden.configure.natives=function(a){f=a.listener,g=a.altenativeListener},function(i,l){Analyze("extend",i);var m=e({},h,l||{}),n=i,o=!0,p=m.names;b.fn(i)?n=i.prototype:(o=!1,b.array(i)&&(a(c(m.arrayMethods,function(a){return{name:a,fun:Array.prototype[a]}}),function(a){i[a.name]=function(){var b=Array.prototype.slice.call(arguments);a.fun.apply(i,b),i.emit({type:a.name,current:i,data:b})}}),Utils.extend(n,{sequentially:function(a){var b=Warden.makeStream().get(),c=this,d=0,e=setInterval(function(){d==c.length?(d=0,clearInterval(e)):b.fire(c[d++])},a);return b},toBus:function(){var b=Warden.makeStream().bus();return a(n,function(a,c){b.data.last=b.data.takes[c]=b.data.fires[c]=a}),b}})));var q=n[p.emit]||n[p.listen]||n[p.unlisten]||n[p.stream];if(b.exist(q))throw new Error("Can't overwrite: "+(q.name?q.name:q)+" of object");return jQueryInited&&(o?!0:i instanceof jQuery)?(m.emitter=m.emitter||"trigger",m.listener=m.listener||"on"):(b.fn(n[f])||b.fn(n[g]))&&(m.listener=m.listener||(b.fn(n[f])?f:g)),n[p.emit]=function(c,e){var f=this,g=b.str(c)?c:c.type,e=b.obj(c)?c:e||c,h=d(k(this.$$id=this.$$id||Utils.$hash.set("o")),function(a){return a.type==g});return a(h,function(a){a.callback.call(f,e)}),this},n[p.listen]=function(b,c){var e=this,f=k(this.$$id=this.$$id||Utils.$hash.set("o"));return Analyze("listen",b),a(b.split(","),function(a){a=Utils.trim(a),!d(f,function(b){return b.type==a}).length&&e[m.listener]&&e[m.listener].apply(e,[a,function(a){e.emit(a)}]),j(e.$$id,{type:a,callback:c})}),this},n[p.unlisten]=function(b,c){var d=k(this.$$id=this.$$id||Utils.$hash.set("o"));return Analyze("unlisten",b),a(b.split(","),function(b){if(b=Utils.trim(b),d.length){var e=[];a(d,function(a,b){a.callback.name==(c.name||c)&&e.push(b)}),a(e,function(a){d.splice(a,1)})}}),this},n[p.stream]=function(b,c){var e=this,f=Warden.makeStream(b,c||this),g=k(this.$$id=this.$$id||Utils.$hash.set("o"));return Analyze("stream",b),a(b.split(","),function(a){a=Utils.trim(a),!d(g,function(b){return b.type==a}).length&&e[m.listener]&&e[m.listener].apply(e,[a,function(a){f.eval(a)}]),j(e.$$id,{type:a,callback:function(a){f.eval(a)}})}),f.get()},i}}(),Warden.makeStream=function(){function a(a){var d,e=[];return{$$id:Utils.$hash.set("s"),$$context:a,eval:function(c){b(e,function(b){b.fire(c,a)})},transform:function(a){c.fn(a)&&(e=Utils.map(e,function(b){a(b)}))},push:function(a){return e.push(a),a},pushAllUp:function(a){function b(a){c.exist(a.parent)&&(e.push(a.parent),b(a.parent))}e.push(a),b(a)},pushAllDown:function(a){var c=this;b(c.push(a).children,function(a){c.pushAllDown(a)})},pop:function(a){return b(e,function(b,c){a.$$id==b.$$id&&(e=e.slice(0,c).concat(e.slice(c+1,e.length)))}),a},popAllDown:function(a){var c=this;b(c.pop(a).children,function(a){c.popAllDown(a)})},popAllUp:function(a){var b=this.pop(a);c.exist(b.parent)&&this.popAllUp(b.parent)},sprint:function(a,b){var c=0,f=this;d=setInterval(function(){e[c]?e[c].fire(b?b(c):c):f.stop(),c++},a)},stop:function(){clearInterval(d)},get:function(){var a=new DataBus;return a.host(this),a},bus:function(){return this.get()}}}var b=Utils.each,c=Utils.is;return function(d,e,f){var g,h,i,j=[];if(Analyze("makeStream",d),e=e||{},g=a(e),c.fn(d)){if(f===!0){h=d.toString();for(i in e)e.hasOwnProperty(i)&&j.push(i);b(j,function(a){h.indexOf("this."+a)>=0&&console.error("Coincidence: property: '"+a+"' is already defined in stream context!",e)})}d.call(e,function(a){g.eval(a)})}return g}}();var DataBus=function(){function a(a,b){a.parent=b,b.children.push(a)}function b(b){var e,g,h=f.get(this.$$id,"processor");return b?(e=[],d(h.process(),function(a){e.push(a)}),e.push(b),g=new c(e),g.host(this.host()),a(g,this),g):h}function c(a){var b=this,c=this.$$id=Utils.$hash.set("d");this.parent=null,this.children=[],this.data={fires:new Utils.Queue,takes:new Utils.Queue,last:null},f.set(c,{bindings:[],processor:new Processor(a||[],b),host:0,handlers:[],setup:function(a){return a}})}var d=Utils.each,e=Utils.is,f={set:function(a,b,c){return e.obj(b)&&!e.exist(c)?this[a]=b:this[a][b]=e.fn(c)?c(this[a][b]):c},get:function(a,b){return e.exist(b)?this[a][b]:this[a]}};return c.prototype.bindTo=function(a,b,c){var d=Warden.watcher(this,a,b,c);return f.get(this.$$id,"bindings").push(d),d},c.prototype.update=function(a){var b=f.get(this.$$id,"bindings");b.length&&d(b,function(b){b.update(a||self.data.takes.last())})},c.prototype.fire=function(a,b){var c=this.$$id,g=this,h=f.get(c,"handlers"),i=f.get(c,"processor");a=f.get(c,"setup")(e.exist(a)?a:{}),this.data.fires.push(a),i.start(a,b,function(a){g.data.takes.push(a),g.update(g.data.last=a),d(h,function(c){c.call(b,a)})})},c.prototype.setup=function(a){Analyze("setup",a),f.set(this.$$id,"setup",function(){return a})},c.prototype.host=function(a){return a?f.set(this.$$id,"host",a):f.get(this.$$id,"host")},c.prototype.listen=function(a){var b=this;return f.set(this.$$id,"handlers",function(c){return c.push(e.fn(a)?a:function(){console.log(a)}),c.length<=1&&b.host().push(b),c}),this},c.prototype.mute=function(a){return a=e.fn(fn)?a.name:a,d(f.get(this.$$id,"handlers"),function(b,c){b.name==a&&f.set(this.$$id,"handlers",function(a){return a.slice(0,c).concat(a.slice(c+1,a.length))})}),this},c.prototype.log=function(){return this.listen(function(a){return console.log(a)})},c.prototype.filter=function(a){return Analyze("filter",a),b.call(this,function(b,c){return a.apply(this,[b])===!0?c.$continue(b):c.$break()})},c.prototype.map=function(a){var c;if(e.fn(a))c=function(b,c){return c.$continue(a.call(this,b))};else if(e.str(a)){if(a.indexOf("/")>=0)return this.get(a);c=function(b,c){var d=b[a],f=e.exist(d)?d:a;return c.$continue(f)}}else c=e.array(a)?function(b,c){var f=[];return d(a,function(a){var c=b[a];f.push(e.exist(c)?c:a)}),c.$continue(f)}:e.obj(a)?function(b,c){var d,f={};for(var g in a)d=b[a[g]],f[g]=e.exist(d)?d:a[g];return c.$continue(f)}:function(b,c){return c.$continue(a)};return b.call(this,c)},c.prototype.nth=function(a){Analyze("nth",a),b.call(this,function(b,c){return c.$continue(b[a])})},c.prototype.get=function(a){return Analyze("get",a),b.call(this,function(b,c){var f=b;return d(a.split("/"),function(a){var b,c=a.length-1;if("["==a[0]&&"]"==a[c]){if(b=a.slice(1,c),e.exist(b)){if(!e.num(parseInt(b)))throw"Wrong syntax at DataBus.get() method";a=parseInt(b)}}else if(!e.exist(f[a]))throw"Can't find "+a+" property";f=f[a]}),c.$continue(f)})},c.prototype.reduce=function(a,c){return 1==arguments.length&&(c=a,a=void 0),Analyze("reduce",c),b.call(this,function(b,d){var e=d.$host(),f=a,g=b;return e.data.takes.length>0&&(f=e.data.takes.last()),d.$continue(c.call(this,f,g))})},c.prototype.take=function(a){return Analyze("take",a),e.fn(a)?this.filter(a):b.call(this,function(b,c){var d=c.$host();return d.data.limit=d.data.limit||a,d.data.takes.length===d.data.limit?c.$break():c.$continue(b)})},c.prototype.include=function(){var a=arguments,c=a.length;return b.call(this,function(b,d){for(var f,g=d.$host(),h=0,i=c;i>h;h++)if(f=a[h],e.array(f))for(var j=0,k=f.length;k>j;j++)e.exist(g.data[f[j]])&&(b[f[j]]=g.data[f[j]]);else e.exist(g.data[f])&&(b[f]=g.data[f]);return d.$continue(b)})},c.prototype.skip=function(a){return Analyze("skip",a),b.call(this,function(b,c){var d=c.$host();return d.data.fires.length<=a?void c.$break():c.$continue(b)})},c.prototype.interpolate=function(a,c){return Analyze("interpolate",a),b.call(this,function(b,d){var e=c||/{{\s*[\w\.]+\s*}}/g;return d.$continue(a.replace(e,function(a){return b[a.slice(2,-2)]}))})},c.prototype.mask=function(a,c){return Analyze("mask",a),b.call(this,function(b,d){var e=c||/{{\s*[\w\.]+\s*}}/g;return d.$continue(b.replace(e,function(b){return a[b.slice(2,-2)]}))})},c.prototype.unique=function(a){return Analyze("unique",a),a=e.fn(a)?a:function(a,b){return a===b},b.call(this,function(b,c){var d=c.$host().data.fires,e=c.$host().data.takes;return(d.length>1||e.length>0)&&(a(b,d[d.length-2])||a(b,e.last()))?c.$break():c.$continue(b)})},c.prototype.debounce=function(a){return Analyze("debounce",a),b.call(this,function(b,c){var d=c.$host();clearTimeout(d.data.dbtimer),d.data.dbtimer=setTimeout(function(){delete d.data.dbtimer,c.$unlock(),c.$continue(b)},a),c.$lock()})},c.prototype.getCollected=function(a){return Analyze("getCollected",a),b.call(this,function(b,c){{var d=c.$host();d.data.fires.length-1}d.data.tmpCollection=d.data.tmpCollection||[],d.data.tmpCollection.push(b),d.data.timer?c.$lock():(d.data.timer=setTimeout(function(){var a=d.data.tmpCollection;clearTimeout(d.data.timer),delete d.data.timer,delete d.data.tmpCollection,c.$unlock(),c.$continue(a)},a),c.$lock())})},c.prototype.delay=function(a){return Analyze("delay",a),b.call(this,function(b,c){setTimeout(function(){c.$continue(b)},a)})},c.prototype.repeat=function(a){var c;return Analyze("repeat",a),this.stopRepeating=function(){clearInterval(c)},b.call(this,function(b,d){c=setInterval(function(){d.$continue(b)},a)})},c.prototype.toggle=function(a,c){var d=this;return this.data.toggle=!1,b.call(this,function(b,e){var f=d.data.toggle?a:c;return d.data.toggle=!d.data.toggle,e.$continue(f.call(d,b))})},c.prototype.after=function(a,c){var d=!1;return a.listen(function(){d=!0}),b.call(this,function(a,b){d?(d=c===!0?!1:!0,b.$unlock(),b.$continue(a)):b.$lock()})},c.prototype.waitFor=function(a){var b=this;return Warden.makeStream(function(c){var d,e=!1,f=function(){d=null,e=!1};a.listen(function(){e&&(c(d),f())}),b.listen(function(a){d=a,e=!0})}).get()},c.prototype.merge=function(a){var b=this,c=Warden.makeStream(function(c){a.listen(c),b.listen(c)}).get();return c},c.prototype.resolveWith=function(a,b){var c=this,d=this.host().$$context;return Warden.makeStream(function(e){c.sync(a).listen(function(a){var c=a[0],f=a[1];e(b.call(d,c,f))})},d).get()},c.prototype.combine=function(a,b,c){var d,e,f=this,c=c||this.host().$$context;return a.listen(function(a){e=a}),this.listen(function(a){d=a}),Warden.makeStream(function(g){function h(){g(b.call(c,d,e))}f.listen(h),a.listen(h)},c).get()},c.prototype.sync=function(b){var c=this,d=Warden.makeStream(function(a){var d,e,f=!1,g=!1,h=function(){d=null,e=null,f=!1,g=!1};b.listen(function(b){f?(a([d,b]),h()):(e=b,g=!0)}),c.listen(function(b){g?(a([b,e]),h()):(d=b,f=!0)})}).bus();return a(d,this),d},c.prototype.syncFlat=function(b){var c=this,d=Warden.makeStream(function(a){c.sync(b).listen(function(b){a(Utils.flatten(b))})}).bus();return a(d,this),d},c.prototype.lock=function(){this.host().pop(this)},c.prototype.lockChildren=function(){this.host().popAllDown(this)},c.prototype.lockParents=function(){this.host().popAllUp(this)},c.prototype.unlock=function(){this.host().push(this)},c.prototype.unlockChildren=function(){this.host().pushAllDown(this)},c.prototype.unlockParents=function(){function a(b){e.exist(b.parent)&&(b.host().push(b.parent),a(b.parent))}this.host().push(this),a(this)},Warden.configure.addToDatabus=function(a,d,e,f){d=d||a.name,c.prototype[d]=function(){return Analyze(d,arguments[f||0]),b.call(this,a(arguments))}},c}();Warden.watcher=function(){var is=Utils.is,each=Utils.each;return function(bus,a,b,c){var argv=Utils.toArray(arguments).slice(1,arguments.length),argc=argv.length,fn;if(!is.exist(b)&&is.exist(a))is.str(a)?fn=function(b){return this[a]=b}:is.obj(a)?fn=function(b){a=b}:is.fn(a)&&(fn=function(b){return a(b)});else if(is.exist(b))if(is.obj(a)&&is.str(b))if(b.split("/").length>1){var dest="";each(b.split("/"),function(name){if(!is.exist(eval("a"+dest)[name]))throw"Unknown property: "+name+" from chain: "+b;dest+='["'+name+'"]'}),fn=function(event){eval("a"+dest+"= event")}}else fn=is.fn(a[b])?function(c){a[b](c)}:function(c){return a[b]=c};else is.obj(a)&&is.fn(b)&&(fn=function(c){return b.call(a,c)});return bus.listen(fn),Utils.extend(new function(){},{update:fn,unbind:function(a){bus.mute(a)},bind:function(){bus.listen(fn||fn)}})}}(),jQueryInited&&Warden.extend(jQuery)});